<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Avanzado de Administraci√≥n de Bodega</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Variables CSS */
        :root {
            --primary: #3F51B5;
            --primary-light: #C5CAE9;
            --primary-dark: #303F9F;
            --secondary: #FF5722;
            --secondary-light: #FFCCBC;
            --success: #4CAF50;
            --success-light: #E8F5E9;
            --danger: #F44336;
            --danger-light: #FFEBEE;
            --warning: #FFC107;
            --warning-light: #FFF8E1;
            --info: #2196F3;
            --info-light: #E3F2FD;
            --light: #FAFAFA;
            --dark: #212121;
            --grey-100: #F5F5F5;
            --grey-200: #EEEEEE;
            --grey-300: #E0E0E0;
            --grey-400: #BDBDBD;
            --grey-500: #9E9E9E;
            --grey-600: #757575;
            --grey-700: #616161;
            --grey-800: #424242;
            --grey-900: #212121;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 0.125rem;
            --radius: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --radius-2xl: 1rem;
            --radius-3xl: 1.5rem;
            --radius-full: 9999px;
            --transition: all 0.2s ease-in-out;
            --header-height: 3.5rem;
            --sidebar-width: 250px;
            --content-max-width: 1200px;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--grey-100);
            color: var(--grey-900);
            font-size: 16px;
            line-height: 1.5;
            position: relative;
            height: 100vh;
            overflow-x: hidden;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: var(--transition);
        }

        ul {
            list-style: none;
        }

        /* Layout */
        .main-grid {
            display: grid;
            grid-template-areas:
                "header header"
                "sidebar content";
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: var(--header-height) 1fr;
            height: 100vh;
        }

        .header {
            grid-area: header;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--primary);
            color: white;
            z-index: 1000;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }

        .header-brand {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .header-brand i {
            margin-right: 0.5rem;
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar {
            grid-area: sidebar;
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background-color: white;
            overflow-y: auto;
            z-index: 900;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .content {
            grid-area: content;
            margin-top: var(--header-height);
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(100vh - var(--header-height));
        }

        .content-container {
            max-width: var(--content-max-width);
            margin: 0 auto;
        }

        /* Sidebar Navigation */
        .nav-menu {
            padding: 1rem 0;
        }

        .nav-item {
            padding: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--radius);
            color: var(--grey-700);
            transition: var(--transition);
        }

        .nav-link:hover {
            background-color: var(--grey-100);
            color: var(--primary);
        }

        .nav-link.active {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 500;
        }

        .nav-link i {
            width: 1.5rem;
            text-align: center;
            font-size: 1.125rem;
        }

        /* Cards */
        .card {
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
            margin-bottom: 1.5rem;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--grey-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--primary);
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--grey-200);
            background-color: var(--grey-50);
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.primary {
            background-color: var(--primary);
        }

        .stat-icon.success {
            background-color: var(--success);
        }

        .stat-icon.warning {
            background-color: var(--warning);
        }

        .stat-icon.danger {
            background-color: var(--danger);
        }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--grey-600);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--grey-900);
            line-height: 1;
        }

        .stat-footer {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: var(--grey-600);
            margin-top: 0.5rem;
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .stat-badge.positive {
            background-color: var(--success-light);
            color: var(--success);
        }

        .stat-badge.negative {
            background-color: var(--danger-light);
            color: var(--danger);
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            background-color: white;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--grey-200);
        }

        .data-table th {
            background-color: var(--grey-100);
            font-weight: 600;
            color: var(--grey-700);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tbody tr {
            transition: var(--transition);
        }

        .data-table tbody tr:hover {
            background-color: var(--grey-100);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Mobile Data List */
        .data-list {
            display: none;
            margin-bottom: 1.5rem;
        }

        .data-item {
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .data-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--grey-100);
            cursor: pointer;
        }

        .data-item-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-item-title .badge {
            margin-left: 0.5rem;
        }

        .data-item-content {
            padding: 1rem;
            display: none;
        }

        .data-item.open .data-item-content {
            display: block;
        }

        .data-item-row {
            display: flex;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--grey-200);
            padding-bottom: 0.5rem;
        }

        .data-item-row:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        .data-item-label {
            width: 40%;
            font-weight: 500;
            color: var(--grey-700);
        }

        .data-item-value {
            width: 60%;
        }

        .data-item-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Forms */
        .form-control {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--grey-700);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--grey-300);
            border-radius: var(--radius);
            font-size: 1rem;
            color: var(--grey-900);
            background-color: white;
            transition: var(--transition);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input::placeholder {
            color: var(--grey-500);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .form-col {
            flex: 1;
            min-width: 250px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .form-help {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: var(--grey-600);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #E64A19;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #388E3C;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #D32F2F;
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--grey-900);
        }

        .btn-warning:hover {
            background-color: #FFA000;
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-info:hover {
            background-color: #1976D2;
        }

        .btn-light {
            background-color: var(--grey-200);
            color: var(--grey-800);
        }

        .btn-light:hover {
            background-color: var(--grey-300);
        }

        .btn-icon {
            padding: 0.5rem;
            font-size: 1rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        .btn-block {
            display: flex;
            width: 100%;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid currentColor;
        }

        .btn-outline.btn-primary {
            color: var(--primary);
        }

        .btn-outline.btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.625rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
        }

        .badge-primary {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }

        .badge-success {
            background-color: var(--success-light);
            color: var(--success);
        }

        .badge-danger {
            background-color: var(--danger-light);
            color: var(--danger);
        }

        .badge-warning {
            background-color: var(--warning-light);
            color: #F57C00;
        }

        .badge-info {
            background-color: var(--info-light);
            color: var(--info);
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: var(--radius);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-icon {
            font-size: 1.25rem;
            padding-top: 0.125rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-success {
            background-color: var(--success-light);
            color: var(--success);
        }

        .alert-danger {
            background-color: var(--danger-light);
            color: var(--danger);
        }

        .alert-warning {
            background-color: var(--warning-light);
            color: #F57C00;
        }

        .alert-info {
            background-color: var(--info-light);
            color: var(--info);
        }

        /* Modals */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            display: none;
            backdrop-filter: blur(4px);
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1051;
            max-width: 95%;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
            opacity: 0;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .modal.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--grey-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--grey-500);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--grey-200);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Search & Filters */
        .search-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .search-container {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid var(--grey-300);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--grey-500);
            pointer-events: none;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem;
            min-width: 180px;
            z-index: 100;
            display: none;
        }

        .filter-menu.open {
            display: block;
        }

        .filter-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .filter-item:hover {
            background-color: var(--grey-100);
        }

        .filter-item.active {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            margin-top: 1.5rem;
        }

        .page-item {
            display: flex;
        }

        .page-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
            font-weight: 500;
            color: var(--grey-700);
        }

        .page-link:hover {
            background-color: var(--grey-200);
        }

        .page-link.active {
            background-color: var(--primary);
            color: white;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--grey-300);
            margin-bottom: 1.5rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-item {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            color: var(--grey-600);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab-item:hover {
            color: var(--primary);
        }

        .tab-item.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Loading indicator */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spinner 1s linear infinite;
        }

        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toasts/Notifications */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 1060;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-width: 350px;
        }

        .toast {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            font-size: 1.25rem;
            padding-top: 0.125rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-close {
            align-self: flex-start;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--grey-500);
            transition: var(--transition);
        }

        .toast-close:hover {
            color: var(--danger);
        }

        .toast-success .toast-icon {
            color: var(--success);
        }

        .toast-danger .toast-icon {
            color: var(--danger);
        }

        .toast-warning .toast-icon {
            color: var(--warning);
        }

        .toast-info .toast-icon {
            color: var(--info);
        }

        /* Dropdowns */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem;
            min-width: 180px;
            z-index: 100;
            display: none;
        }

        .dropdown-menu.open {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            cursor: pointer;
            border-radius: var(--radius);
            transition: var(--transition);
            font-weight: 500;
        }

        .dropdown-item:hover {
            background-color: var(--grey-100);
        }

        .dropdown-item i {
            font-size: 1.125rem;
            width: 1.25rem;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text {
            visibility: hidden;
            background-color: var(--grey-800);
            color: white;
            text-align: center;
            border-radius: var(--radius);
            padding: 0.5rem 0.75rem;
            position: absolute;
            z-index: 1070;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: var(--shadow);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--grey-800) transparent transparent transparent;
        }

        /* Mobile Menu */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-menu-close {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--grey-600);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 900;
        }

        .mobile-nav-menu {
            display: flex;
            justify-content: space-around;
        }

        .mobile-nav-item {
            flex: 1;
            text-align: center;
        }

        .mobile-nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
            color: var(--grey-600);
            font-size: 0.75rem;
        }

        .mobile-nav-link i {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .mobile-nav-link.active {
            color: var(--primary);
        }

        /* Detail panel for mobile */
        .detail-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            max-width: 400px;
            background-color: white;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .detail-panel.open {
            transform: translateX(0);
        }

        .detail-panel-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--grey-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detail-panel-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .detail-panel-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--grey-600);
            cursor: pointer;
        }

        .detail-panel-body {
            padding: 1.25rem;
            flex: 1;
            overflow-y: auto;
        }

        .detail-panel-footer {
            padding: 1.25rem;
            border-top: 1px solid var(--grey-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .detail-group {
            margin-bottom: 1.25rem;
        }

        .detail-label {
            font-weight: 500;
            color: var(--grey-700);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: var(--grey-900);
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 1.5rem;
        }

        /* Responsive Adjustments */
        @media (max-width: 991.98px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1020;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .content {
                margin-left: 0;
            }

            .main-grid {
                grid-template-areas:
                    "header header"
                    "content content";
                grid-template-columns: 1fr;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .mobile-menu-close {
                display: block;
            }
        }

        @media (max-width: 767.98px) {
            .header {
                padding: 0 1rem;
            }

            .header-brand span {
                display: none;
            }

            .content {
                padding: 1rem;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-col {
                width: 100%;
            }

            .data-table {
                display: none;
            }

            .data-list {
                display: block;
            }

            .table-responsive {
                box-shadow: none;
            }

            .mobile-nav {
                display: block;
            }

            .content {
                padding-bottom: 5rem;
            }

            .chart-container {
                height: 300px;
            }
        }

        @media (min-width: 768px) {
            .data-table {
                display: table;
            }
        }

        /* Connection status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
        }

        .connection-status.connected {
            background-color: var(--success-light);
            color: var(--success);
        }

        .connection-status.disconnected {
            background-color: var(--danger-light);
            color: var(--danger);
        }

        /* Utils */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-0 {
            margin-bottom: 0 !important;
        }

        .mt-0 {
            margin-top: 0 !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mt-2 {
            margin-top: 0.5rem !important;
        }

        .mb-4 {
            margin-bottom: 1rem !important;
        }

        .mt-4 {
            margin-top: 1rem !important;
        }

        .mb-6 {
            margin-bottom: 1.5rem !important;
        }

        .mt-6 {
            margin-top: 1.5rem !important;
        }

        .hidden {
            display: none !important;
        }

        .text-primary {
            color: var(--primary) !important;
        }

        .text-success {
            color: var(--success) !important;
        }

        .text-danger {
            color: var(--danger) !important;
        }

        .text-warning {
            color: var(--warning) !important;
        }

        .text-info {
            color: var(--info) !important;
        }

        .font-bold {
            font-weight: 700 !important;
        }

        .font-semibold {
            font-weight: 600 !important;
        }

        .font-medium {
            font-weight: 500 !important;
        }

        .font-normal {
            font-weight: 400 !important;
        }

        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
    <!-- Charts.js para gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>

<body>
    <!-- Loading Indicator -->
    <div class="loading" id="appLoading">
        <div class="loading-spinner"></div>
    </div>

    <div class="main-grid">
        <!-- Top Header -->
        <header class="header">
            <div class="header-brand">
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <i class="fas fa-box-open"></i>
                <span>Sistema de Bodega</span>
            </div>
            <div class="header-actions">
                <div class="connection-status disconnected" id="connectionStatus">
                    <i class="fas fa-plug"></i>
                    <span>Desconectado</span>
                </div>
                <div class="dropdown">
                    <button class="btn btn-icon" id="notificationToggle">
                        <i class="fas fa-bell"></i>
                    </button>
                    <div class="dropdown-menu" id="notificationMenu">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-icon" id="userToggle">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <div class="dropdown-menu" id="userMenu">
                        <div class="dropdown-item">
                            <i class="fas fa-user"></i>
                            <span>Mi Perfil</span>
                        </div>
                        <div class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            <span>Configuraci√≥n</span>
                        </div>
                        <div class="dropdown-item">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Cerrar Sesi√≥n</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="mobile-menu-close" id="sidebarClose">
                <i class="fas fa-times"></i>
            </button>
            <nav class="nav-menu">
                <ul>
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#inventario" class="nav-link" data-section="inventario">
                            <i class="fas fa-boxes"></i>
                            <span>Inventario</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#entregas" class="nav-link" data-section="entregas">
                            <i class="fas fa-truck-loading"></i>
                            <span>Entregas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#personal" class="nav-link" data-section="personal">
                            <i class="fas fa-users"></i>
                            <span>Personal</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#prestamos" class="nav-link" data-section="prestamos">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Pr√©stamos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#programacion" class="nav-link" data-section="programacion">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Programaci√≥n</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#reportes" class="nav-link" data-section="reportes">
                            <i class="fas fa-chart-bar"></i>
                            <span>Reportes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#configuracion" class="nav-link" data-section="configuracion">
                            <i class="fas fa-cogs"></i>
                            <span>Configuraci√≥n</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <div class="content-container">
                <!-- Dashboard Section -->
                <section id="dashboard" class="section active">
                    <h1 class="mb-6">Dashboard</h1>

                    <div class="dashboard-cards">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <div class="stat-title">Total Insumos</div>
                                    <div class="stat-value" id="totalInsumos">0</div>
                                </div>
                                <div class="stat-icon primary">
                                    <i class="fas fa-box"></i>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span class="stat-badge positive">
                                    <i class="fas fa-arrow-up"></i> <span id="insumosTendencia">0%</span>
                                </span>
                                vs. mes anterior
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <div class="stat-title">Alertas</div>
                                    <div class="stat-value" id="totalAlertas">0</div>
                                </div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span class="stat-badge positive">
                                    <i class="fas fa-arrow-down"></i> <span id="alertasTendencia">0%</span>
                                </span>
                                vs. mes anterior
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <div class="stat-title">Entregas</div>
                                    <div class="stat-value" id="totalEntregas">0</div>
                                </div>
                                <div class="stat-icon success">
                                    <i class="fas fa-hand-holding-box"></i>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span class="stat-badge positive">
                                    <i class="fas fa-arrow-up"></i> <span id="entregasTendencia">0%</span>
                                </span>
                                vs. mes anterior
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <div class="stat-title">Aseadores</div>
                                    <div class="stat-value" id="totalAseadores">0</div>
                                </div>
                                <div class="stat-icon info">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span class="stat-badge negative">
                                    <i class="fas fa-arrow-down"></i> <span id="aseadoresTendencia">0%</span>
                                </span>
                                vs. mes anterior
                            </div>
                        </div>
                    </div>

                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Alertas de Stock
                            </h2>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary" id="refreshAlertas">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table" id="alertasTable">
                                    <thead>
                                        <tr>
                                            <th>Insumo</th>
                                            <th>Stock Actual</th>
                                            <th>Stock M√≠nimo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="alertasTableBody">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="data-list" id="alertasList">
                                <!-- Se llena din√°micamente para m√≥viles -->
                            </div>
                        </div>
                    </div>

                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-calendar-check"></i>
                                Entregas Programadas para Hoy
                            </h2>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary" id="refreshProgramadas">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table" id="programadasTable">
                                    <thead>
                                        <tr>
                                            <th>Aseador</th>
                                            <th>Insumo</th>
                                            <th>Cantidad</th>
                                            <th>Tipo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="programadasTableBody">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="data-list" id="programadasList">
                                <!-- Se llena din√°micamente para m√≥viles -->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Actividad Reciente
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="actividadChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Inventario Section -->
                <section id="inventario" class="section">
                    <h1 class="mb-6">Gesti√≥n de Inventario</h1>

                    <div class="search-filter-container">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="searchInventario"
                                placeholder="Buscar insumo...">
                        </div>
                        <button class="btn btn-primary" id="addInsumoBtn">
                            <i class="fas fa-plus"></i> Nuevo Insumo
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-boxes"></i>
                                Listado de Insumos
                            </h2>
                            <div class="btn-group">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" id="filterInventarioBtn">
                                        <i class="fas fa-filter"></i> Filtrar
                                    </button>
                                    <div class="filter-menu" id="filterInventarioMenu">
                                        <div class="filter-item active" data-filter="todos">Todos los insumos</div>
                                        <div class="filter-item" data-filter="bajoStock">Bajo stock</div>
                                        <div class="filter-item" data-filter="limpieza">Categor√≠a: Limpieza</div>
                                        <div class="filter-item" data-filter="herramientas">Categor√≠a: Herramientas
                                        </div>
                                        <div class="filter-item" data-filter="seguridad">Categor√≠a: Seguridad</div>
                                        <div class="filter-item" data-filter="oficina">Categor√≠a: Oficina</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-light" id="exportInventarioBtn">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table" id="inventarioTable">
                                    <thead>
                                        <tr>
                                            <th>Insumo</th>
                                            <th>Categor√≠a</th>
                                            <th>Stock</th>
                                            <th>Stock M√≠nimo</th>
                                            <th>√öltima Actualizaci√≥n</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventarioTableBody">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="data-list" id="inventarioList">
                                <!-- Se llena din√°micamente para m√≥viles -->
                            </div>

                            <div class="pagination" id="inventarioPagination">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <div class="card mt-6">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                Distribuci√≥n de Inventario por Categor√≠a
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="inventarioCategoriaChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Entregas Section -->
                <section id="entregas" class="section">
                    <h1 class="mb-6">Gesti√≥n de Entregas</h1>

                    <div class="search-filter-container">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="searchEntregas" placeholder="Buscar entrega...">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="addEntregaBtn">
                                <i class="fas fa-hand-holding"></i> Nueva Entrega
                            </button>
                            <button class="btn btn-light" id="addRecepcionBtn">
                                <i class="fas fa-truck-loading"></i> Nueva Recepci√≥n
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-exchange-alt"></i>
                                Historial de Movimientos
                            </h2>
                            <div class="btn-group">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" id="filterEntregasBtn">
                                        <i class="fas fa-filter"></i> Filtrar
                                    </button>
                                    <div class="filter-menu" id="filterEntregasMenu">
                                        <div class="filter-item active" data-filter="todos">Todos los movimientos</div>
                                        <div class="filter-item" data-filter="entregas">Solo entregas</div>
                                        <div class="filter-item" data-filter="recepciones">Solo recepciones</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-light" id="exportEntregasBtn">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table" id="entregasTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                            <th>Destinatario/Origen</th>
                                            <th>Insumos</th>
                                            <th>Motivo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="entregasTableBody">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="data-list" id="entregasList">
                                <!-- Se llena din√°micamente para m√≥viles -->
                            </div>

                            <div class="pagination" id="entregasPagination">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <div class="card mt-6">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Tendencia de Entregas
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="entregasChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Personal Section -->
                <section id="personal" class="section">
                    <h1 class="mb-6">Gesti√≥n de Personal</h1>

                    <div class="search-filter-container">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="searchPersonal"
                                placeholder="Buscar personal...">
                        </div>
                        <button class="btn btn-primary" id="addPersonalBtn">
                            <i class="fas fa-user-plus"></i> Nuevo Aseador
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-users"></i>
                                Listado de Personal
                            </h2>
                            <div class="btn-group">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" id="filterPersonalBtn">
                                        <i class="fas fa-filter"></i> Filtrar
                                    </button>
                                    <div class="filter-menu" id="filterPersonalMenu">
                                        <div class="filter-item active" data-filter="todos">Todo el personal</div>
                                        <div class="filter-item" data-filter="activos">Solo activos</div>
                                        <div class="filter-item" data-filter="inactivos">Solo inactivos</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-light" id="exportPersonalBtn">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table" id="personalTable">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>√Årea</th>
                                            <th>Fecha de Registro</th>
                                            <th>Insumos Asignados</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="personalTableBody">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="data-list" id="personalList">
                                <!-- Se llena din√°micamente para m√≥viles -->
                            </div>

                            <div class="pagination" id="personalPagination">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <div class="card mt-6">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                Distribuci√≥n de Insumos por Aseador
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="personalInsumosChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Pr√©stamos Section -->
                <section id="prestamos" class="section">
                    <h1 class="mb-6">Gesti√≥n de Pr√©stamos</h1>

                    <div class="search-filter-container">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="searchPrestamos"
                                placeholder="Buscar pr√©stamo...">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="addPrestamoBtn">
                                <i class="fas fa-share-square"></i> Nuevo Pr√©stamo
                            </button>
                            <button class="btn btn-light" id="addDevolucionBtn">
                                <i class="fas fa-undo"></i> Registrar Devoluci√≥n
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-exchange-alt"></i>
                                Pr√©stamos y Devoluciones
                            </h2>
                            <div class="btn-group">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" id="filterPrestamosBtn">
                                        <i class="fas fa-filter"></i> Filtrar
                                    </button>
                                    <div class="filter-menu" id="filterPrestamosMenu">
                                        <div class="filter-item active" data-filter="todos">Todos los pr√©stamos</div>
                                        <div class="filter-item" data-filter="pendientes">Pendientes de devoluci√≥n</div>
                                        <div class="filter-item" data-filter="devueltos">Devueltos</div>
                                        <div class="filter-item" data-filter="entregados">Pr√©stamos entregados</div>
                                        <div class="filter-item" data-filter="recibidos">Pr√©stamos recibidos</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-light" id="exportPrestamosBtn">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table" id="prestamosTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Terminal</th>
                                            <th>Tipo</th>
                                            <th>Insumos</th>
                                            <th>Estado</th>
                                            <th>Fecha Devoluci√≥n</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prestamosTableBody">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="data-list" id="prestamosList">
                                <!-- Se llena din√°micamente para m√≥viles -->
                            </div>

                            <div class="pagination" id="prestamosPagination">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <div class="card mt-6">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                Estado de Pr√©stamos
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="prestamosEstadoChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Programaci√≥n Section -->
                <section id="programacion" class="section">
                    <h1 class="mb-6">Programaci√≥n de Entregas</h1>

                    <div class="search-filter-container">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="searchProgramacion"
                                placeholder="Buscar programaci√≥n...">
                        </div>
                        <button class="btn btn-primary" id="addProgramacionBtn">
                            <i class="fas fa-calendar-plus"></i> Nueva Programaci√≥n
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-calendar-alt"></i>
                                Entregas Programadas
                            </h2>
                            <div class="btn-group">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" id="filterProgramacionBtn">
                                        <i class="fas fa-filter"></i> Filtrar
                                    </button>
                                    <div class="filter-menu" id="filterProgramacionMenu">
                                        <div class="filter-item active" data-filter="todos">Todas las programaciones
                                        </div>
                                        <div class="filter-item" data-filter="activas">Activas</div>
                                        <div class="filter-item" data-filter="inactivas">Inactivas</div>
                                        <div class="filter-item" data-filter="proximas">Pr√≥ximas 7 d√≠as</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-light" id="exportProgramacionBtn">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table" id="programacionTable">
                                    <thead>
                                        <tr>
                                            <th>Aseador</th>
                                            <th>Insumo</th>
                                            <th>Frecuencia</th>
                                            <th>√öltima Entrega</th>
                                            <th>Pr√≥xima Entrega</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="programacionTableBody">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="data-list" id="programacionList">
                                <!-- Se llena din√°micamente para m√≥viles -->
                            </div>

                            <div class="pagination" id="programacionPagination">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <div class="card mt-6">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-calendar-check"></i>
                                Programaci√≥n Pr√≥ximos 30 D√≠as
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="programacionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Reportes Section -->
                <section id="reportes" class="section">
                    <h1 class="mb-6">Reportes y Estad√≠sticas</h1>

                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                Generar Reporte
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-control">
                                        <label class="form-label" for="reporteTipo">Tipo de Reporte</label>
                                        <select class="form-select" id="reporteTipo">
                                            <option value="inventario">Inventario Actual</option>
                                            <option value="movimientos">Movimientos de Inventario</option>
                                            <option value="entregas">Entregas por Aseador</option>
                                            <option value="consumo">Consumo de Insumos</option>
                                            <option value="prestamos">Pr√©stamos y Devoluciones</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-control">
                                        <label class="form-label" for="reportePeriodo">Per√≠odo</label>
                                        <select class="form-select" id="reportePeriodo">
                                            <option value="semana">√öltima Semana</option>
                                            <option value="mes" selected>√öltimo Mes</option>
                                            <option value="trimestre">√öltimo Trimestre</option>
                                            <option value="anual">√öltimo A√±o</option>
                                            <option value="personalizado">Personalizado</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row" id="fechasPersonalizadas" style="display: none;">
                                <div class="form-col">
                                    <div class="form-control">
                                        <label class="form-label" for="reporteFechaInicio">Fecha Inicio</label>
                                        <input type="date" class="form-input" id="reporteFechaInicio">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-control">
                                        <label class="form-label" for="reporteFechaFin">Fecha Fin</label>
                                        <input type="date" class="form-input" id="reporteFechaFin">
                                    </div>
                                </div>
                            </div>

                            <div class="text-right">
                                <button class="btn btn-primary" id="generarReporteBtn">
                                    <i class="fas fa-file-alt"></i> Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                Resultado
                            </h2>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light" id="exportReporteBtn">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                                <button class="btn btn-sm btn-light" id="printReporteBtn">
                                    <i class="fas fa-print"></i> Imprimir
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="reporteResultado">
                            <div class="text-center">
                                <p>Seleccione un tipo de reporte y per√≠odo para generar el informe.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Configuraci√≥n Section -->
                <section id="configuracion" class="section">
                    <h1 class="mb-6">Configuraci√≥n</h1>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-cog"></i>
                                Configuraci√≥n del Sistema
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="tabs">
                                <div class="tab-item active" data-tab="general">General</div>
                                <div class="tab-item" data-tab="notificaciones">Notificaciones</div>
                                <div class="tab-item" data-tab="conexion">Conexi√≥n a Google Sheets</div>
                                <div class="tab-item" data-tab="backup">Respaldo y Recuperaci√≥n</div>
                            </div>

                            <div class="tab-content active" id="tabGeneral">
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-control">
                                            <label class="form-label" for="configNombreEmpresa">Nombre de la
                                                Empresa</label>
                                            <input type="text" class="form-input" id="configNombreEmpresa"
                                                value="Cleaner S.A.">
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-control">
                                            <label class="form-label" for="configStockMinimo">Stock M√≠nimo por
                                                Defecto</label>
                                            <input type="number" class="form-input" id="configStockMinimo" value="10">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <button class="btn btn-primary" id="guardarConfigBtn">
                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                    </button>
                                </div>
                            </div>

                            <div class="tab-content" id="tabNotificaciones">
                                <div class="form-control">
                                    <label class="form-label">Notificaciones por Email</label>
                                    <div class="form-group">
                                        <input type="checkbox" id="notifBajoStock" checked>
                                        <label for="notifBajoStock">Alertas de bajo stock</label>
                                    </div>
                                    <div class="form-group">
                                        <input type="checkbox" id="notifEntregas" checked>
                                        <label for="notifEntregas">Entregas programadas para hoy</label>
                                    </div>
                                    <div class="form-group">
                                        <input type="checkbox" id="notifPrestamos" checked>
                                        <label for="notifPrestamos">Recordatorios de devoluci√≥n de pr√©stamos</label>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="form-label" for="configEmailDestinatario">Email para
                                        Notificaciones</label>
                                    <input type="email" class="form-input" id="configEmailDestinatario"
                                        placeholder="ejemplo@empresa.com">
                                </div>

                                <div class="form-control">
                                    <button class="btn btn-primary" id="guardarNotificacionesBtn">
                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                    </button>
                                    <button class="btn btn-light" id="probarEmailBtn">
                                        <i class="fas fa-paper-plane"></i> Probar Conexi√≥n
                                    </button>
                                </div>
                            </div>

                            <div class="tab-content" id="tabConexion">
                                <div class="alert alert-info">
                                    <div class="alert-icon">
                                        <i class="fas fa-info-circle"></i>
                                    </div>
                                    <div class="alert-content">
                                        <div class="alert-title">Conexi√≥n a Google Sheets</div>
                                        <p>Configure la conexi√≥n a Google Sheets para sincronizar los datos. Necesitar√°
                                            la URL del script web del proyecto de Apps Script.</p>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="form-label" for="configScriptUrl">URL del Script Web</label>
                                    <input type="text" id="configScriptUrl" class="form-input"
                                        placeholder="https://script.google.com/macros/s/ID_DEL_SCRIPT/exec">
                                    <span class="form-help">
                                        Pega aqu√≠ la URL completa del script desplegado (que termina en /exec)
                                    </span>
                                </div>

                                <div class="form-control">
                                    <label class="form-label">Estado</label>
                                    <div class="connection-status disconnected" id="sheetConnectionStatus">
                                        <i class="fas fa-plug"></i>
                                        <span>Desconectado</span>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="form-label">Hojas Requeridas</label>
                                    <ul>
                                        <li>insumos</li>
                                        <li>personal</li>
                                        <li>entregas</li>
                                        <li>prestamos</li>
                                        <li>programacion</li>
                                        <li>configuracion</li>
                                    </ul>
                                </div>

                                <div class="form-control">
                                    <button class="btn btn-primary" id="conectarSheetsBtn">
                                        <i class="fas fa-link"></i> Conectar
                                    </button>
                                    <button class="btn btn-light" id="probarConexionBtn">
                                        <i class="fas fa-sync-alt"></i> Probar Conexi√≥n
                                    </button>
                                </div>
                            </div>

                            <div class="tab-content" id="tabBackup">
                                <div class="form-control">
                                    <label class="form-label">Respaldo de Datos</label>
                                    <p>Realice una copia de seguridad de los datos del sistema o restaure desde un
                                        respaldo anterior.</p>
                                </div>

                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-control">
                                            <button class="btn btn-primary" id="exportarDatosBtn">
                                                <i class="fas fa-download"></i> Exportar Datos
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-control">
                                            <label class="form-label" for="importarDatosInput">Importar Datos</label>
                                            <input type="file" id="importarDatosInput" class="form-input"
                                                accept=".json">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-control">
                                    <button class="btn btn-warning" id="importarDatosBtn">
                                        <i class="fas fa-upload"></i> Cargar Archivo Seleccionado
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav-menu">
                <li class="mobile-nav-item">
                    <a href="#dashboard" class="mobile-nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="#inventario" class="mobile-nav-link" data-section="inventario">
                        <i class="fas fa-boxes"></i>
                        <span>Inventario</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="#entregas" class="mobile-nav-link" data-section="entregas">
                        <i class="fas fa-truck-loading"></i>
                        <span>Entregas</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="#personal" class="mobile-nav-link" data-section="personal">
                        <i class="fas fa-users"></i>
                        <span>Personal</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="#more" class="mobile-nav-link" data-section="more" id="mobileMoreBtn">
                        <i class="fas fa-ellipsis-h"></i>
                        <span>M√°s</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Modales -->
    <!-- Modal de Nuevo Insumo -->
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal" id="modalInsumo">
        <div class="modal-header">
            <h3 class="modal-title" id="modalInsumoTitle">Nuevo Insumo</h3>
            <button class="modal-close" id="closeModalInsumo">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formInsumo">
                <input type="hidden" id="insumoId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="insumoNombre">Nombre del Insumo</label>
                            <input type="text" class="form-input" id="insumoNombre" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="insumoCategoria">Categor√≠a</label>
                            <select class="form-select" id="insumoCategoria">
                                <option value="limpieza">Limpieza</option>
                                <option value="herramientas">Herramientas</option>
                                <option value="seguridad">Seguridad</option>
                                <option value="oficina">Oficina</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="insumoUnidad">Unidad de Medida</label>
                            <select class="form-select" id="insumoUnidad">
                                <option value="unidad">Unidad</option>
                                <option value="litro">Litro</option>
                                <option value="kilo">Kilo</option>
                                <option value="par">Par</option>
                                <option value="caja">Caja</option>
                                <option value="rollo">Rollo</option>
                                <option value="saco">Saco</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="insumoStock">Stock Inicial</label>
                            <input type="number" class="form-input" id="insumoStock" min="0" value="0" required>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="insumoStockMinimo">Stock M√≠nimo</label>
                            <input type="number" class="form-input" id="insumoStockMinimo" min="1" value="10" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="insumoVidaUtil">Vida √ötil</label>
                            <select class="form-select" id="insumoVidaUtil">
                                <option value="7">1 semana</option>
                                <option value="14">2 semanas</option>
                                <option value="30" selected>1 mes</option>
                                <option value="90">3 meses</option>
                                <option value="180">6 meses</option>
                                <option value="365">1 a√±o</option>
                                <option value="indefinido">Indefinido</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <label class="form-label" for="insumoNotas">Notas Adicionales</label>
                    <textarea class="form-textarea" id="insumoNotas"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" id="cancelarInsumo">Cancelar</button>
            <button class="btn btn-primary" id="guardarInsumo">Guardar</button>
        </div>
    </div>

    <!-- Modal de Nueva Entrega -->
    <div class="modal" id="modalEntrega">
        <div class="modal-header">
            <h3 class="modal-title" id="modalEntregaTitle">Nueva Entrega</h3>
            <button class="modal-close" id="closeModalEntrega">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formEntrega">
                <input type="hidden" id="entregaId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="entregaAseador">Aseador</label>
                            <select class="form-select" id="entregaAseador" required>
                                <option value="">Seleccionar Aseador</option>
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="entregaFecha">Fecha</label>
                            <input type="date" class="form-input" id="entregaFecha" required>
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <label class="form-label" for="entregaMotivo">Motivo</label>
                    <select class="form-select" id="entregaMotivo" required>
                        <option value="reposicion">Reposici√≥n</option>
                        <option value="nuevo">Primera entrega</option>
                        <option value="perdida">Por p√©rdida</option>
                        <option value="robo">Por robo</option>
                        <option value="dano">Por da√±o</option>
                    </select>
                </div>
                <div id="entregaInsumosContainer">
                    <div class="form-row entrega-insumo-row">
                        <div class="form-col">
                            <div class="form-control">
                                <label class="form-label" for="entregaInsumo1">Insumo</label>
                                <select class="form-select entrega-insumo" id="entregaInsumo1" required>
                                    <option value="">Seleccionar Insumo</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-control">
                                <label class="form-label" for="entregaCantidad1">Cantidad</label>
                                <input type="number" class="form-input entrega-cantidad" id="entregaCantidad1" min="1"
                                    value="1" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <button type="button" class="btn btn-sm btn-light" id="agregarInsumoEntrega">
                        <i class="fas fa-plus"></i> Agregar otro insumo
                    </button>
                </div>
                <div class="form-control">
                    <label class="form-label" for="entregaNotas">Notas Adicionales</label>
                    <textarea class="form-textarea" id="entregaNotas"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" id="cancelarEntrega">Cancelar</button>
            <button class="btn btn-primary" id="guardarEntrega">Guardar</button>
        </div>
    </div>

    <!-- Modal de Nueva Recepci√≥n -->
    <div class="modal" id="modalRecepcion">
        <div class="modal-header">
            <h3 class="modal-title">Nueva Recepci√≥n</h3>
            <button class="modal-close" id="closeModalRecepcion">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formRecepcion">
                <input type="hidden" id="recepcionId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="recepcionOrigen">Proveedor/Origen</label>
                            <input type="text" class="form-input" id="recepcionOrigen" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="recepcionFecha">Fecha</label>
                            <input type="date" class="form-input" id="recepcionFecha" required>
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <label class="form-label" for="recepcionDocumento">N√∫mero de Documento</label>
                    <input type="text" class="form-input" id="recepcionDocumento" placeholder="Factura/Gu√≠a/OC">
                </div>
                <div id="recepcionInsumosContainer">
                    <div class="form-row recepcion-insumo-row">
                        <div class="form-col">
                            <div class="form-control">
                                <label class="form-label" for="recepcionInsumo1">Insumo</label>
                                <select class="form-select recepcion-insumo" id="recepcionInsumo1" required>
                                    <option value="">Seleccionar Insumo</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-control">
                                <label class="form-label" for="recepcionCantidad1">Cantidad</label>
                                <input type="number" class="form-input recepcion-cantidad" id="recepcionCantidad1"
                                    min="1" value="1" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <button type="button" class="btn btn-sm btn-light" id="agregarInsumoRecepcion">
                        <i class="fas fa-plus"></i> Agregar otro insumo
                    </button>
                </div>
                <div class="form-control">
                    <label class="form-label" for="recepcionNotas">Notas Adicionales</label>
                    <textarea class="form-textarea" id="recepcionNotas"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" id="cancelarRecepcion">Cancelar</button>
            <button class="btn btn-primary" id="guardarRecepcion">Guardar</button>
        </div>
    </div>

    <!-- Panel de detalles m√≥vil -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-panel-header">
            <h3 class="detail-panel-title" id="detailPanelTitle">Detalles</h3>
            <button class="detail-panel-close" id="closeDetailPanel">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="detail-panel-body" id="detailPanelContent">
            <!-- Se llena din√°micamente -->
        </div>
        <div class="detail-panel-footer">
            <button class="btn btn-light" id="closeDetailPanelBtn">Cerrar</button>
            <button class="btn btn-primary" id="detailActionBtn">Acci√≥n</button>
        </div>
    </div>

    <!-- Modal de Nuevo Personal -->
    <div class="modal" id="modalPersonal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalPersonalTitle">Nuevo Aseador</h3>
            <button class="modal-close" id="closeModalPersonal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPersonal">
                <input type="hidden" id="personalId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="personalNombre">Nombre Completo</label>
                            <input type="text" class="form-input" id="personalNombre" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="personalRut">RUT</label>
                            <input type="text" class="form-input" id="personalRut" placeholder="12345678-9">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="personalArea">√Årea</label>
                            <input type="text" class="form-input" id="personalArea" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="personalTelefono">Tel√©fono</label>
                            <input type="tel" class="form-input" id="personalTelefono">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="personalEmail">Email</label>
                            <input type="email" class="form-input" id="personalEmail">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="personalEstado">Estado</label>
                            <select class="form-select" id="personalEstado">
                                <option value="activo" selected>Activo</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <label class="form-label" for="personalNotas">Notas Adicionales</label>
                    <textarea class="form-textarea" id="personalNotas"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" id="cancelarPersonal">Cancelar</button>
            <button class="btn btn-primary" id="guardarPersonal">Guardar</button>
        </div>
    </div>

    <!-- Modal de Nuevo Pr√©stamo -->
    <div class="modal" id="modalPrestamo">
        <div class="modal-header">
            <h3 class="modal-title" id="modalPrestamoTitle">Nuevo Pr√©stamo</h3>
            <button class="modal-close" id="closeModalPrestamo">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPrestamo">
                <input type="hidden" id="prestamoId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="prestamoTerminal">Terminal</label>
                            <input type="text" class="form-input" id="prestamoTerminal" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="prestamoFecha">Fecha</label>
                            <input type="date" class="form-input" id="prestamoFecha" required>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="prestamoTipo">Tipo</label>
                            <select class="form-select" id="prestamoTipo" required>
                                <option value="salida">Pr√©stamo a otro terminal</option>
                                <option value="entrada">Pr√©stamo recibido</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="prestamoContacto">Contacto</label>
                            <input type="text" class="form-input" id="prestamoContacto">
                        </div>
                    </div>
                </div>
                <div id="prestamoInsumosContainer">
                    <div class="form-row prestamo-insumo-row">
                        <div class="form-col">
                            <div class="form-control">
                                <label class="form-label" for="prestamoInsumo1">Insumo</label>
                                <select class="form-select prestamo-insumo" id="prestamoInsumo1" required>
                                    <option value="">Seleccionar Insumo</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-control">
                                <label class="form-label" for="prestamoCantidad1">Cantidad</label>
                                <input type="number" class="form-input prestamo-cantidad" id="prestamoCantidad1" min="1"
                                    value="1" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <button type="button" class="btn btn-sm btn-light" id="agregarInsumoPrestamo">
                        <i class="fas fa-plus"></i> Agregar otro insumo
                    </button>
                </div>
                <div class="form-control">
                    <label class="form-label" for="prestamoFechaDevolucion">Fecha Estimada de Devoluci√≥n</label>
                    <input type="date" class="form-input" id="prestamoFechaDevolucion">
                </div>
                <div class="form-control">
                    <label class="form-label" for="prestamoNotas">Notas Adicionales</label>
                    <textarea class="form-textarea" id="prestamoNotas"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" id="cancelarPrestamo">Cancelar</button>
            <button class="btn btn-primary" id="guardarPrestamo">Guardar</button>
        </div>
    </div>

    <!-- Modal de Nueva Programaci√≥n -->
    <div class="modal" id="modalProgramacion">
        <div class="modal-header">
            <h3 class="modal-title" id="modalProgramacionTitle">Nueva Programaci√≥n</h3>
            <button class="modal-close" id="closeModalProgramacion">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formProgramacion">
                <input type="hidden" id="programacionId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="programacionAseador">Aseador</label>
                            <select class="form-select" id="programacionAseador" required>
                                <option value="">Seleccionar Aseador</option>
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="programacionInsumo">Insumo</label>
                            <select class="form-select" id="programacionInsumo" required>
                                <option value="">Seleccionar Insumo</option>
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="programacionFrecuencia">Frecuencia</label>
                            <select class="form-select" id="programacionFrecuencia" required>
                                <option value="7">Semanal</option>
                                <option value="14">Quincenal</option>
                                <option value="30" selected>Mensual</option>
                                <option value="90">Trimestral</option>
                                <option value="180">Semestral</option>
                                <option value="365">Anual</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="programacionCantidad">Cantidad</label>
                            <input type="number" class="form-input" id="programacionCantidad" min="1" value="1"
                                required>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="programacionInicio">Fecha Inicio</label>
                            <input type="date" class="form-input" id="programacionInicio" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="programacionFin">Fecha Fin (opcional)</label>
                            <input type="date" class="form-input" id="programacionFin">
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <label class="form-label" for="programacionNotas">Notas Adicionales</label>
                    <textarea class="form-textarea" id="programacionNotas"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" id="cancelarProgramacion">Cancelar</button>
            <button class="btn btn-primary" id="guardarProgramacion">Guardar</button>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div class="modal" id="modalConfirmacion">
        <div class="modal-header">
            <h3 class="modal-title">Confirmar Acci√≥n</h3>
            <button class="modal-close" id="closeModalConfirmacion">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmacionMensaje">¬øEst√°s seguro de realizar esta acci√≥n?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" id="cancelarConfirmacion">Cancelar</button>
            <button class="btn btn-danger" id="confirmarAccion">Confirmar</button>
        </div>
    </div>

    <!-- Modal M√°s Opciones (M√≥vil) -->
    <div class="modal" id="modalMoreOptions">
        <div class="modal-header">
            <h3 class="modal-title">M√°s Opciones</h3>
            <button class="modal-close" id="closeModalMoreOptions">&times;</button>
        </div>
        <div class="modal-body">
            <div class="mobile-more-menu">
                <a href="#prestamos" class="dropdown-item" data-section="prestamos">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Pr√©stamos</span>
                </a>
                <a href="#programacion" class="dropdown-item" data-section="programacion">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Programaci√≥n</span>
                </a>
                <a href="#reportes" class="dropdown-item" data-section="reportes">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>
                <a href="#configuracion" class="dropdown-item" data-section="configuracion">
                    <i class="fas fa-cogs"></i>
                    <span>Configuraci√≥n</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Modal de Devoluci√≥n -->
    <div class="modal" id="modalDevolucion">
        <div class="modal-header">
            <h3 class="modal-title">Registrar Devoluci√≥n</h3>
            <button class="modal-close" id="closeModalDevolucion">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formDevolucion">
                <input type="hidden" id="devolucionPrestamoId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="devolucionPrestamo">Pr√©stamo</label>
                            <select class="form-select" id="devolucionPrestamo" required>
                                <option value="">Seleccionar Pr√©stamo</option>
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-control">
                            <label class="form-label" for="devolucionFecha">Fecha de Devoluci√≥n</label>
                            <input type="date" class="form-input" id="devolucionFecha" required>
                        </div>
                    </div>
                </div>
                <div class="form-control">
                    <label class="form-label" for="devolucionNotas">Notas</label>
                    <textarea class="form-textarea" id="devolucionNotas"
                        placeholder="Observaciones sobre la devoluci√≥n"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" id="cancelarDevolucion">Cancelar</button>
            <button class="btn btn-primary" id="guardarDevolucion">Registrar Devoluci√≥n</button>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer">
        <!-- Toast notifications will be added dynamically -->
    </div>
    <script src="/navegacion.js"></script>
    <!-- JavaScript -->
    <script>
        // =========================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // =========================================

      
      
        const SPREADSHEET_ID = '1gdOiPNqcfb6Mc5Y60fz_6KGnpM2MqB8JWesJsxrIGbI'; // Reemplaza esto

        // Variable para manejar el estado de conexi√≥n con Google Sheets
        let isConnectedToSheets = false;

        // Variables para la navegaci√≥n
        let currentSection = "dashboard";
        let currentConfirmAction = null;
        let isMobile = window.innerWidth < 768;

        // Estructura inicial de la base de datos (vac√≠a)
        const DB_STRUCTURE = {
            insumos: [],
            personal: [],
            entregas: [],
            prestamos: [],
            programaciones: [],
            configuracion: {
                nombreEmpresa: "Empresa",
                stockMinimoPorDefecto: 10,
                emailNotificaciones: "",
                notificaciones: {
                    bajoStock: true,
                    entregas: true,
                    prestamos: true
                },
                scriptUrl: "https://script.google.com/macros/s/AKfycbwYVHldQ3Tpjs-MEOYfqNF9S9ZkBIRbyqqbAQCLbyLodmxEknf2sZKjZRg9cgKbJP4X/exec"
            }
        };

        // Objetos para los gr√°ficos
        let actividadChart = null;
        let inventarioCategoriaChart = null;
        let entregasChart = null;
        let personalInsumosChart = null;
        let prestamosEstadoChart = null;
        let programacionChart = null;


        // =========================================
        // INICIALIZACI√ìN DEL SISTEMA
        // =========================================

        document.addEventListener('DOMContentLoaded', function () {
            showLoading();

            // Inicializar la base de datos local si no existe
            initializeDB();

            // Detectar si es dispositivo m√≥vil
            checkMobileView();
            window.addEventListener('resize', checkMobileView);

            // Inicializar la navegaci√≥n
            initNavigation();

            // Inicializar los dropdowns
            initDropdowns();

            // Inicializar los modales
            initModals();

            // Inicializar las pesta√±as
            initTabs();

            // Inicializar la paginaci√≥n
            initPagination();

            // Cargar la configuraci√≥n y comprobar conexi√≥n
            loadConfiguration();

            // Cargar datos iniciales
            loadAllData();

            // Verificar alertas diarias
            verificarAlertasDiarias();

            // Inicializar gr√°ficos
            initCharts();

            // Ocultar loading
            hideLoading();

            // Mostrar notificaci√≥n de bienvenida
            showToast({
                type: 'success',
                title: 'Sistema Iniciado',
                message: 'Bienvenido al Sistema de Administraci√≥n de Bodega'
            });
        });

        function loadAllData() {
            // Cargar todos los datos
            loadDashboardData();
            loadInventoryData();
            loadPersonalData();
            loadEntregasData();
            loadPrestamosData();
            loadProgramacionData();

            // Actualizar los selectores
            updateAllSelects();
        }

        function updateAllSelects() {
            updateEntregasAseadorSelect();
            updateEntregasInsumoSelect();
            updateRecepcionInsumoSelect();
            updatePrestamoInsumoSelect();
            updateProgramacionAseadorSelect();
            updateProgramacionInsumoSelect();
            updateDevolucionPrestamoSelect();
        }

        function initializeDB() {
            if (!localStorage.getItem('bodegaDB')) {
                // Inicializar con estructura base vac√≠a
                localStorage.setItem('bodegaDB', JSON.stringify(DB_STRUCTURE));
            } else {
                // Asegurar que la estructura est√° completa
                const db = getDB();
                let updated = false;

                // Verificar cada tabla
                if (!db.insumos) {
                    db.insumos = [];
                    updated = true;
                }
                if (!db.personal) {
                    db.personal = [];
                    updated = true;
                }
                if (!db.entregas) {
                    db.entregas = [];
                    updated = true;
                }
                if (!db.prestamos) {
                    db.prestamos = [];
                    updated = true;
                }
                if (!db.programaciones) {
                    db.programaciones = [];
                    updated = true;
                }
                if (!db.configuracion) {
                    db.configuracion = DB_STRUCTURE.configuracion;
                    updated = true;
                } else {
                    // Verificar propiedades de configuraci√≥n
                    if (db.configuracion.notificaciones === undefined) {
                        db.configuracion.notificaciones = DB_STRUCTURE.configuracion.notificaciones;
                        updated = true;
                    }
                }

                if (updated) {
                    saveDB(db);
                }
            }
        }

        function loadConfiguration() {
            const db = getDB();

            // Cargar configuraci√≥n general
            document.getElementById('configNombreEmpresa').value = db.configuracion.nombreEmpresa || '';
            document.getElementById('configStockMinimo').value = db.configuracion.stockMinimoPorDefecto || 10;

            // Cargar configuraci√≥n de notificaciones
            document.getElementById('configEmailDestinatario').value = db.configuracion.emailNotificaciones || '';
            document.getElementById('notifBajoStock').checked = db.configuracion.notificaciones?.bajoStock !== false;
            document.getElementById('notifEntregas').checked = db.configuracion.notificaciones?.entregas !== false;
            document.getElementById('notifPrestamos').checked = db.configuracion.notificaciones?.prestamos !== false;

            // Cargar configuraci√≥n de conexi√≥n
            document.getElementById('configScriptUrl').value = db.configuracion.scriptUrl || '';

            // Verificar si hay una URL de script guardada y probar la conexi√≥n
            if (db.configuracion.scriptUrl) {
                GOOGLE_SCRIPT_URL = db.configuracion.scriptUrl;
                checkSheetsConnection();
            }
        }

        // =========================================
        // CONEXI√ìN CON GOOGLE SHEETS
        // =========================================

        function checkSheetsConnection() {
            if (!GOOGLE_SCRIPT_URL) {
                updateConnectionStatus(false);
                return;
            }

            showLoading();

            callGoogleScript('ping')
                .then(response => {
                    if (response && response.success) {
                        updateConnectionStatus(true);
                        isConnectedToSheets = true;

                        // Cargar notificaciones
                        loadNotifications();
                    } else {
                        updateConnectionStatus(false);
                        isConnectedToSheets = false;
                        console.error('Error de conexi√≥n:', response?.error || 'No se recibi√≥ respuesta');
                    }
                })
                .catch(error => {
                    updateConnectionStatus(false);
                    isConnectedToSheets = false;
                    console.error('Error de conexi√≥n:', error);
                })
                .finally(() => {
                    hideLoading();
                });
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const sheetStatusElement = document.getElementById('sheetConnectionStatus');

            if (connected) {
                // Actualizar indicador en header
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = '<i class="fas fa-plug"></i><span>Conectado</span>';

                // Actualizar indicador en configuraci√≥n
                if (sheetStatusElement) {
                    sheetStatusElement.className = 'connection-status connected';
                    sheetStatusElement.innerHTML = '<i class="fas fa-check-circle"></i><span>Conectado</span>';
                }
            } else {
                // Actualizar indicador en header
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = '<i class="fas fa-plug"></i><span>Desconectado</span>';

                // Actualizar indicador en configuraci√≥n
                if (sheetStatusElement) {
                    sheetStatusElement.className = 'connection-status disconnected';
                    sheetStatusElement.innerHTML = '<i class="fas fa-times-circle"></i><span>Desconectado</span>';
                }
            }
        }

        function callGoogleScript(action, data = null) {
            if (!GOOGLE_SCRIPT_URL) {
                return Promise.reject(new Error('URL del script no configurada'));
            }

            // Preparar la URL con los par√°metros
            const params = new URLSearchParams();

            if (data !== null) {
                if (typeof data === 'object') {
                    // Para POST, el cuerpo ser√° un objeto JSON
                    return fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: action,
                            data: data
                        })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error: ${response.status}`);
                            }
                            return response.json();
                        })
                        .catch(error => {
                            console.error('Error en la llamada al script:', error);
                            throw error;
                        });
                } else {
                    // Si data no es un objeto, a√±adirlo como par√°metro URL
                    params.append('data', data);
                }
            }

            // A√±adir la acci√≥n como par√°metro
            params.append('action', action);

            // Realizar la solicitud GET
            return fetch(`${GOOGLE_SCRIPT_URL}?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Error en la llamada al script:', error);
                    throw error;
                });
        }

        function syncWithGoogleSheets() {
            if (!isConnectedToSheets) {
                showToast({
                    type: 'warning',
                    title: 'Sin Conexi√≥n',
                    message: 'No hay conexi√≥n con Google Sheets. Configure la conexi√≥n primero.'
                });
                return Promise.resolve(false);
            }

            showLoading();

            const db = getDB();

            return callGoogleScript('sync', db)
                .then(result => {
                    if (result.success) {
                        showToast({
                            type: 'success',
                            title: 'Sincronizaci√≥n Completa',
                            message: 'Los datos se han sincronizado correctamente con Google Sheets'
                        });
                        return true;
                    } else {
                        throw new Error(result.error || 'Error en la sincronizaci√≥n');
                    }
                })
                .catch(error => {
                    console.error('Error de sincronizaci√≥n:', error);
                    showToast({
                        type: 'danger',
                        title: 'Error de Sincronizaci√≥n',
                        message: error.message || 'Error al sincronizar con Google Sheets'
                    });
                    return false;
                })
                .finally(() => {
                    hideLoading();
                });
        }

        function loadFromGoogleSheets() {
            if (!isConnectedToSheets) {
                showToast({
                    type: 'warning',
                    title: 'Sin Conexi√≥n',
                    message: 'No hay conexi√≥n con Google Sheets. Configure la conexi√≥n primero.'
                });
                return Promise.resolve(false);
            }

            showLoading();

            return callGoogleScript('getAllData')
                .then(result => {
                    if (result.success && result.data) {
                        // Verificar que tenemos todos los datos necesarios
                        const requiredTables = ['insumos', 'personal', 'entregas', 'prestamos', 'programaciones', 'configuracion'];
                        const missingTables = requiredTables.filter(table => !result.data[table]);

                        if (missingTables.length > 0) {
                            throw new Error(`Faltan las siguientes tablas: ${missingTables.join(', ')}`);
                        }

                        // Guardar los datos en localStorage
                        localStorage.setItem('bodegaDB', JSON.stringify(result.data));

                        // Recargar los datos
                        loadAllData();

                        showToast({
                            type: 'success',
                            title: 'Datos Cargados',
                            message: 'Los datos se han cargado correctamente desde Google Sheets'
                        });
                        return true;
                    } else {
                        throw new Error(result.error || 'No se recibieron datos v√°lidos');
                    }
                })
                .catch(error => {
                    console.error('Error al cargar datos:', error);
                    showToast({
                        type: 'danger',
                        title: 'Error al Cargar Datos',
                        message: error.message || 'Error al cargar datos desde Google Sheets'
                    });
                    return false;
                })
                .finally(() => {
                    hideLoading();
                });
        }

        function loadNotifications() {
            if (!isConnectedToSheets) return;

            callGoogleScript('getNotifications')
                .then(result => {
                    if (result.success && result.data && Array.isArray(result.data)) {
                        // Actualizar el men√∫ de notificaciones
                        const notificationMenu = document.getElementById('notificationMenu');
                        notificationMenu.innerHTML = '';

                        if (result.data.length === 0) {
                            notificationMenu.innerHTML = `
                                <div class="dropdown-item">
                                    <i class="fas fa-bell-slash text-info"></i>
                                    <span>No hay notificaciones nuevas</span>
                                </div>
                            `;
                        } else {
                            result.data.forEach(notification => {
                                let iconClass = 'fas fa-info-circle text-info';

                                if (notification.type === 'alert') {
                                    iconClass = 'fas fa-exclamation-triangle text-warning';
                                } else if (notification.type === 'warning') {
                                    iconClass = 'fas fa-exclamation-circle text-danger';
                                } else if (notification.type === 'success') {
                                    iconClass = 'fas fa-check-circle text-success';
                                }

                                notificationMenu.innerHTML += `
                                    <div class="dropdown-item">
                                        <i class="${iconClass}"></i>
                                        <span>${notification.message}</span>
                                    </div>
                                `;
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al cargar notificaciones:', error);
                });
        }

        // =========================================
        // FUNCIONES PARA LA BASE DE DATOS
        // =========================================

        function getDB() {
            const dbData = localStorage.getItem('bodegaDB');
            if (!dbData) {
                return DB_STRUCTURE;
            }

            try {
                return JSON.parse(dbData);
            } catch (e) {
                console.error('Error al parsear la base de datos:', e);
                return DB_STRUCTURE;
            }
        }

        function saveDB(db) {
            localStorage.setItem('bodegaDB', JSON.stringify(db));

            // Si est√° conectado a Google Sheets, sincronizar
            if (isConnectedToSheets) {
                // No esperamos a que termine la sincronizaci√≥n para no bloquear la interfaz
                syncWithGoogleSheets().catch(error => {
                    console.error('Error al sincronizar:', error);
                });
            }

            return db;
        }

        function getNextId(array) {
            return array.length > 0 ? Math.max(...array.map(item => item.id)) + 1 : 1;
        }

        // =========================================
        // NAVEGACI√ìN Y UI
        // =========================================

        function initNavigation() {
            // Enlaces de navegaci√≥n principal
            document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');

                    // Si es el bot√≥n "M√°s" en m√≥vil
                    if (section === 'more') {
                        openModal('modalMoreOptions');
                        return;
                    }

                    navigateToSection(section);

                    // Si est√° en m√≥vil, cerrar el sidebar
                    if (isMobile) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                });
            });

            // Bot√≥n de apertura del men√∫ m√≥vil
            document.getElementById('mobileMenuToggle').addEventListener('click', function () {
                document.getElementById('sidebar').classList.toggle('open');
            });

            // Bot√≥n de cierre del sidebar
            document.getElementById('sidebarClose').addEventListener('click', function () {
                document.getElementById('sidebar').classList.remove('open');
            });

            // Enlaces en el modal "M√°s Opciones"
            document.querySelectorAll('#modalMoreOptions .dropdown-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    navigateToSection(section);
                    closeModal('modalMoreOptions');
                });
            });

            // Verificar si hay un hash en la URL para la navegaci√≥n inicial
            if (window.location.hash) {
                const section = window.location.hash.substring(1);
                navigateToSection(section);
            }
        }

        function navigateToSection(section) {
            // Verificar si la secci√≥n existe
            if (!document.getElementById(section)) {
                return;
            }

            // Actualizar navegaci√≥n
            document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
                link.classList.remove('active');
            });

            document.querySelectorAll(`.nav-link[data-section="${section}"], .mobile-nav-link[data-section="${section}"]`).forEach(link => {
                link.classList.add('active');
            });

            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active');
            });

            // Mostrar la secci√≥n seleccionada
            document.getElementById(section).classList.add('active');

            // Actualizar la secci√≥n actual
            currentSection = section;

            // Actualizar la URL
            history.pushState(null, null, `#${section}`);

            // Si cambiamos a una secci√≥n con gr√°ficos, actualizarlos
            updateChartsForSection(section);
        }

        function initDropdowns() {
            // User dropdown
            document.getElementById('userToggle').addEventListener('click', function () {
                document.getElementById('userMenu').classList.toggle('open');
            });

            // Notification dropdown
            document.getElementById('notificationToggle').addEventListener('click', function () {
                document.getElementById('notificationMenu').classList.toggle('open');
            });

            // Filter dropdowns
            document.querySelectorAll('[id$="FilterBtn"]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const menuId = this.id.replace('Btn', 'Menu');
                    document.getElementById(menuId).classList.toggle('open');
                });
            });

            // Cerrar dropdowns al hacer click fuera
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu, .filter-menu').forEach(menu => {
                        menu.classList.remove('open');
                    });
                }
            });

            // Filtros
            document.querySelectorAll('.filter-item').forEach(item => {
                item.addEventListener('click', function () {
                    const parentMenu = this.closest('.filter-menu');
                    const filterId = parentMenu.id;
                    const filterValue = this.getAttribute('data-filter');

                    // Actualizar estado activo
                    parentMenu.querySelectorAll('.filter-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Cerrar men√∫
                    parentMenu.classList.remove('open');

                    // Aplicar filtro
                    applyFilter(filterId, filterValue);
                });
            });
        }

        function applyFilter(filterId, value) {
            switch (filterId) {
                case 'filterInventarioMenu':
                    filterInventario(value);
                    break;
                case 'filterEntregasMenu':
                    filterEntregas(value);
                    break;
                case 'filterPersonalMenu':
                    filterPersonal(value);
                    break;
                case 'filterPrestamosMenu':
                    filterPrestamos(value);
                    break;
                case 'filterProgramacionMenu':
                    filterProgramacion(value);
                    break;
            }
        }

        function initModals() {
            // Botones para abrir modales
            document.getElementById('addInsumoBtn').addEventListener('click', () => openModal('modalInsumo', { mode: 'new' }));
            document.getElementById('addEntregaBtn').addEventListener('click', () => openModal('modalEntrega', { mode: 'new' }));
            document.getElementById('addRecepcionBtn').addEventListener('click', () => openModal('modalRecepcion', { mode: 'new' }));
            document.getElementById('addPersonalBtn').addEventListener('click', () => openModal('modalPersonal', { mode: 'new' }));
            document.getElementById('addPrestamoBtn').addEventListener('click', () => openModal('modalPrestamo', { mode: 'new' }));
            document.getElementById('addDevolucionBtn').addEventListener('click', () => openModal('modalDevolucion', { mode: 'new' }));
            document.getElementById('addProgramacionBtn').addEventListener('click', () => openModal('modalProgramacion', { mode: 'new' }));

            // Botones para cerrar modales
            document.querySelectorAll('.modal-close, [id^="cancelar"], [id^="closeModal"]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const modalId = this.closest('.modal').id;
                    closeModal(modalId);
                });
            });

            // Cerrar modal al hacer click fuera
            document.getElementById('modalBackdrop').addEventListener('click', function () {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    closeModal(modal.id);
                });
            });

            // Botones de guardar en modales
            document.getElementById('guardarInsumo').addEventListener('click', saveInsumo);
            document.getElementById('guardarEntrega').addEventListener('click', saveEntrega);
            document.getElementById('guardarRecepcion').addEventListener('click', saveRecepcion);
            document.getElementById('guardarPersonal').addEventListener('click', savePersonal);
            document.getElementById('guardarPrestamo').addEventListener('click', savePrestamo);
            document.getElementById('guardarDevolucion').addEventListener('click', saveDevolucion);
            document.getElementById('guardarProgramacion').addEventListener('click', saveProgramacion);

            // Bot√≥n de confirmar acci√≥n
            document.getElementById('confirmarAccion').addEventListener('click', function () {
                if (currentConfirmAction) {
                    currentConfirmAction();
                }
                closeModal('modalConfirmacion');
            });

            // Botones de agregar insumos
            document.getElementById('agregarInsumoEntrega').addEventListener('click', () => addInsumoRow('entrega'));
            document.getElementById('agregarInsumoRecepcion').addEventListener('click', () => addInsumoRow('recepcion'));
            document.getElementById('agregarInsumoPrestamo').addEventListener('click', () => addInsumoRow('prestamo'));

            // Botones de configuraci√≥n
            document.getElementById('guardarConfigBtn').addEventListener('click', saveConfiguracion);
            document.getElementById('guardarNotificacionesBtn').addEventListener('click', saveNotificaciones);
            document.getElementById('conectarSheetsBtn').addEventListener('click', conectarGoogleSheets);
            document.getElementById('probarConexionBtn').addEventListener('click', checkSheetsConnection);

            // Botones de reportes
            document.getElementById('generarReporteBtn').addEventListener('click', generarReporte);
            document.getElementById('exportReporteBtn').addEventListener('click', exportarReporte);
            document.getElementById('printReporteBtn').addEventListener('click', imprimirReporte);

            // Botones de respaldo y recuperaci√≥n
            document.getElementById('exportarDatosBtn').addEventListener('click', exportarDatos);
            document.getElementById('importarDatosBtn').addEventListener('click', importarDatos);

            // Botones de actualizaci√≥n en dashboard
            document.getElementById('refreshAlertas').addEventListener('click', function () {
                loadDashboardData();
                showToast({
                    type: 'info',
                    title: 'Actualizado',
                    message: 'Datos de alertas actualizados'
                });
            });

            document.getElementById('refreshProgramadas').addEventListener('click', function () {
                loadDashboardData();
                showToast({
                    type: 'info',
                    title: 'Actualizado',
                    message: 'Datos de programaciones actualizados'
                });
            });
        }

        function openModal(modalId, options = {}) {
            // Mostrar backdrop
            document.getElementById('modalBackdrop').style.display = 'block';

            // Mostrar modal
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';

            // Activar animaci√≥n
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);

            // Configurar modal seg√∫n opciones
            switch (modalId) {
                case 'modalInsumo':
                    setupInsumoModal(options);
                    break;
                case 'modalEntrega':
                    setupEntregaModal(options);
                    break;
                case 'modalRecepcion':
                    setupRecepcionModal(options);
                    break;
                case 'modalPersonal':
                    setupPersonalModal(options);
                    break;
                case 'modalPrestamo':
                    setupPrestamoModal(options);
                    break;
                case 'modalDevolucion':
                    setupDevolucionModal(options);
                    break;
                case 'modalProgramacion':
                    setupProgramacionModal(options);
                    break;
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');

            setTimeout(() => {
                modal.style.display = 'none';

                // Ocultar backdrop si no hay modales activos
                if (document.querySelectorAll('.modal.active').length === 0) {
                    document.getElementById('modalBackdrop').style.display = 'none';
                }
            }, 300);
        }

        function confirmAction(message, action) {
            document.getElementById('confirmacionMensaje').textContent = message;
            currentConfirmAction = action;
            openModal('modalConfirmacion');
        }

        function initTabs() {
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', function () {
                    const targetTab = this.getAttribute('data-tab');
                    const tabsContainer = this.closest('.tabs');

                    // Actualizar pesta√±as
                    tabsContainer.querySelectorAll('.tab-item').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Actualizar contenido
                    const tabsContent = tabsContainer.nextElementSibling;
                    const tabContentContainer = tabsContent.parentElement;

                    tabContentContainer.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    document.getElementById(`tab${targetTab.charAt(0).toUpperCase() + targetTab.slice(1)}`).classList.add('active');
                });
            });

            // Per√≠odo personalizado en reportes
            document.getElementById('reportePeriodo').addEventListener('change', function () {
                document.getElementById('fechasPersonalizadas').style.display =
                    this.value === 'personalizado' ? 'flex' : 'none';
            });
        }

        function initPagination() {
            const defaultPagination = `
                <li class="page-item"><a href="#" class="page-link" data-page="prev"><i class="fas fa-chevron-left"></i></a></li>
                <li class="page-item"><a href="#" class="page-link active" data-page="1">1</a></li>
                <li class="page-item"><a href="#" class="page-link" data-page="next"><i class="fas fa-chevron-right"></i></a></li>
            `;

            document.querySelectorAll('[id$="Pagination"]').forEach(pagination => {
                pagination.innerHTML = defaultPagination;
            });

            // Eventos de paginaci√≥n
            document.addEventListener('click', function (e) {
                if (e.target.closest('.page-link')) {
                    e.preventDefault();
                    const pageLink = e.target.closest('.page-link');
                    const page = pageLink.getAttribute('data-page');
                    const paginationId = pageLink.closest('.pagination').id;

                    handlePagination(paginationId, page);
                }
            });
        }

        function handlePagination(paginationId, page) {
            // En una implementaci√≥n real, aqu√≠ se manejar√≠a la paginaci√≥n
            console.log(`Paginaci√≥n ${paginationId} a p√°gina ${page}`);
        }

        function checkMobileView() {
            isMobile = window.innerWidth < 768;

            // Actualizar elementos seg√∫n el tama√±o
            if (isMobile) {
                document.querySelectorAll('.data-table').forEach(table => {
                    table.style.display = 'none';
                });
                document.querySelectorAll('.data-list').forEach(list => {
                    list.style.display = 'block';
                });
            } else {
                document.querySelectorAll('.data-table').forEach(table => {
                    table.style.display = 'table';
                });
                document.querySelectorAll('.data-list').forEach(list => {
                    list.style.display = 'none';
                });
            }
        }

        function setupDataItem(dataItem, toggleFn) {
            const header = dataItem.querySelector('.data-item-header');

            header.addEventListener('click', function () {
                dataItem.classList.toggle('open');
            });

            if (toggleFn) {
                toggleFn(dataItem);
            }
        }

        // =========================================
        // GR√ÅFICOS
        // =========================================

        function initCharts() {
            // Inicializar gr√°ficos con configuraci√≥n base
            // Se completar√°n con datos cuando se navegue a la secci√≥n correspondiente

            // Dashboard - Actividad Reciente
            const actividadCtx = document.getElementById('actividadChart')?.getContext('2d');
            if (actividadCtx) {
                actividadChart = new Chart(actividadCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Actividad Reciente'
                            },
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            // Inventario - Categor√≠as
            const inventarioCategoriaCtx = document.getElementById('inventarioCategoriaChart')?.getContext('2d');
            if (inventarioCategoriaCtx) {
                inventarioCategoriaChart = new Chart(inventarioCategoriaCtx, {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribuci√≥n por Categor√≠a'
                            },
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            // Entregas - Tendencia
            const entregasCtx = document.getElementById('entregasChart')?.getContext('2d');
            if (entregasCtx) {
                entregasChart = new Chart(entregasCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Tendencia de Entregas'
                            },
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            // Personal - Insumos
            const personalInsumosCtx = document.getElementById('personalInsumosChart')?.getContext('2d');
            if (personalInsumosCtx) {
                personalInsumosChart = new Chart(personalInsumosCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribuci√≥n de Insumos por Aseador'
                            },
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Pr√©stamos - Estado
            const prestamosEstadoCtx = document.getElementById('prestamosEstadoChart')?.getContext('2d');
            if (prestamosEstadoCtx) {
                prestamosEstadoChart = new Chart(prestamosEstadoCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Estado de Pr√©stamos'
                            },
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            // Programaci√≥n - Pr√≥ximos 30 d√≠as
            const programacionCtx = document.getElementById('programacionChart')?.getContext('2d');
            if (programacionCtx) {
                programacionChart = new Chart(programacionCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Entregas Programadas (Pr√≥ximos 30 d√≠as)'
                            },
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Actualizar los gr√°ficos para la secci√≥n actual
            updateChartsForSection(currentSection);
        }

        function updateChartsForSection(section) {
            switch (section) {
                case 'dashboard':
                    updateDashboardCharts();
                    break;
                case 'inventario':
                    updateInventarioCharts();
                    break;
                case 'entregas':
                    updateEntregasCharts();
                    break;
                case 'personal':
                    updatePersonalCharts();
                    break;
                case 'prestamos':
                    updatePrestamosCharts();
                    break;
                case 'programacion':
                    updateProgramacionCharts();
                    break;
            }
        }

        function updateDashboardCharts() {
            if (!actividadChart) return;

            const db = getDB();

            // Obtener datos de los √∫ltimos 30 d√≠as
            const today = new Date();
            const dates = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }

            // Contar entregas y recepciones por d√≠a
            const entregasPorDia = {};
            const recepcionesPorDia = {};

            dates.forEach(date => {
                entregasPorDia[date] = 0;
                recepcionesPorDia[date] = 0;
            });

            // Contar entregas
            db.entregas.forEach(entrega => {
                if (dates.includes(entrega.fecha)) {
                    if (entrega.tipo === 'entrega') {
                        entregasPorDia[entrega.fecha]++;
                    } else if (entrega.tipo === 'recepcion') {
                        recepcionesPorDia[entrega.fecha]++;
                    }
                }
            });

            // Contar pr√©stamos por d√≠a
            const prestamosPorDia = {};
            dates.forEach(date => {
                prestamosPorDia[date] = 0;
            });

            db.prestamos.forEach(prestamo => {
                if (dates.includes(prestamo.fecha)) {
                    prestamosPorDia[prestamo.fecha]++;
                }
            });

            // Actualizar gr√°fico
            actividadChart.data.labels = dates.map(date => formatShortDate(date));
            actividadChart.data.datasets = [
                {
                    label: 'Entregas',
                    data: dates.map(date => entregasPorDia[date]),
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Recepciones',
                    data: dates.map(date => recepcionesPorDia[date]),
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Pr√©stamos',
                    data: dates.map(date => prestamosPorDia[date]),
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4
                }
            ];

            actividadChart.update();
        }

        function updateInventarioCharts() {
            if (!inventarioCategoriaChart) return;

            const db = getDB();

            // Agrupar insumos por categor√≠a
            const categorias = {};

            db.insumos.forEach(insumo => {
                const categoria = insumo.categoria || 'sin_categoria';
                if (!categorias[categoria]) {
                    categorias[categoria] = 0;
                }
                categorias[categoria] += insumo.stock || 0;
            });

            // Colores para cada categor√≠a
            const colores = {
                'limpieza': 'rgba(76, 175, 80, 0.7)',
                'herramientas': 'rgba(33, 150, 243, 0.7)',
                'seguridad': 'rgba(255, 152, 0, 0.7)',
                'oficina': 'rgba(156, 39, 176, 0.7)',
                'otros': 'rgba(158, 158, 158, 0.7)',
                'sin_categoria': 'rgba(96, 125, 139, 0.7)'
            };

            // Actualizar gr√°fico
            const categoriasLabels = Object.keys(categorias).map(cat => capitalize(cat.replace('_', ' ')));
            const categoriasData = Object.values(categorias);
            const categoriasColors = Object.keys(categorias).map(cat => colores[cat] || 'rgba(158, 158, 158, 0.7)');

            inventarioCategoriaChart.data.labels = categoriasLabels;
            inventarioCategoriaChart.data.datasets = [
                {
                    data: categoriasData,
                    backgroundColor: categoriasColors,
                    borderWidth: 1
                }
            ];

            inventarioCategoriaChart.update();
        }

        function updateEntregasCharts() {
            if (!entregasChart) return;

            const db = getDB();

            // Obtener datos de los √∫ltimos 6 meses
            const today = new Date();
            const meses = [];

            for (let i = 5; i >= 0; i--) {
                const date = new Date(today);
                date.setMonth(today.getMonth() - i);

                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const monthStr = month < 10 ? `0${month}` : `${month}`;

                meses.push(`${year}-${monthStr}`);
            }

            // Contar entregas y recepciones por mes
            const entregasPorMes = {};
            const recepcionesPorMes = {};

            meses.forEach(mes => {
                entregasPorMes[mes] = 0;
                recepcionesPorMes[mes] = 0;
            });

            db.entregas.forEach(entrega => {
                const mes = entrega.fecha.substring(0, 7);
                if (meses.includes(mes)) {
                    if (entrega.tipo === 'entrega') {
                        entregasPorMes[mes]++;
                    } else if (entrega.tipo === 'recepcion') {
                        recepcionesPorMes[mes]++;
                    }
                }
            });

            // Actualizar gr√°fico
            entregasChart.data.labels = meses.map(mes => formatShortMonth(mes));
            entregasChart.data.datasets = [
                {
                    label: 'Entregas',
                    data: meses.map(mes => entregasPorMes[mes]),
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: 'rgba(76, 175, 80, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Recepciones',
                    data: meses.map(mes => recepcionesPorMes[mes]),
                    backgroundColor: 'rgba(33, 150, 243, 0.7)',
                    borderColor: 'rgba(33, 150, 243, 1)',
                    borderWidth: 1
                }
            ];

            entregasChart.update();
        }

        function updatePersonalCharts() {
            if (!personalInsumosChart) return;

            const db = getDB();

            // Contar insumos entregados a cada aseador
            const insumosPorAseador = {};

            db.personal.forEach(persona => {
                if (persona.estado === 'activo') {
                    insumosPorAseador[persona.id] = 0;
                }
            });

            db.entregas.forEach(entrega => {
                if (entrega.tipo === 'entrega' && entrega.aseadorId && insumosPorAseador[entrega.aseadorId] !== undefined) {
                    entrega.insumos.forEach(item => {
                        insumosPorAseador[entrega.aseadorId] += item.cantidad || 0;
                    });
                }
            });

            // Preparar datos para el gr√°fico
            const aseadores = [];
            const cantidades = [];
            const colores = [];

            // Ordenar por cantidad (descendente)
            const aseadoresOrdenados = Object.keys(insumosPorAseador)
                .map(id => ({
                    id: parseInt(id),
                    cantidad: insumosPorAseador[id]
                }))
                .sort((a, b) => b.cantidad - a.cantidad);

            // Limitar a los 10 principales
            const topAseadores = aseadoresOrdenados.slice(0, 10);

            topAseadores.forEach((item, index) => {
                const persona = db.personal.find(p => p.id === item.id);
                aseadores.push(persona ? persona.nombre : `Aseador ${item.id}`);
                cantidades.push(item.cantidad);

                // Color din√°mico
                const hue = 200 + (index * 15) % 160; // Variaci√≥n de azules-verdes
                colores.push(`hsla(${hue}, 70%, 60%, 0.7)`);
            });

            // Actualizar gr√°fico
            personalInsumosChart.data.labels = aseadores;
            personalInsumosChart.data.datasets = [
                {
                    label: 'Insumos Asignados',
                    data: cantidades,
                    backgroundColor: colores,
                    borderColor: colores.map(c => c.replace('0.7', '1')),
                    borderWidth: 1
                }
            ];

            personalInsumosChart.update();
        }

        function updatePrestamosCharts() {
            if (!prestamosEstadoChart) return;

            const db = getDB();

            // Contar pr√©stamos por estado y tipo
            const pendientesSalida = db.prestamos.filter(p => p.estado === 'pendiente' && p.tipo === 'salida').length;
            const pendientesEntrada = db.prestamos.filter(p => p.estado === 'pendiente' && p.tipo === 'entrada').length;
            const devueltosSalida = db.prestamos.filter(p => p.estado === 'devuelto' && p.tipo === 'salida').length;
            const devueltosEntrada = db.prestamos.filter(p => p.estado === 'devuelto' && p.tipo === 'entrada').length;

            // Actualizar gr√°fico
            prestamosEstadoChart.data.labels = [
                'Pr√©stamos Pendientes (Salida)',
                'Pr√©stamos Pendientes (Entrada)',
                'Pr√©stamos Devueltos (Salida)',
                'Pr√©stamos Devueltos (Entrada)'
            ];

            prestamosEstadoChart.data.datasets = [
                {
                    data: [pendientesSalida, pendientesEntrada, devueltosSalida, devueltosEntrada],
                    backgroundColor: [
                        'rgba(255, 152, 0, 0.7)',    // Pendientes Salida (Naranja)
                        'rgba(156, 39, 176, 0.7)',   // Pendientes Entrada (Morado)
                        'rgba(76, 175, 80, 0.7)',    // Devueltos Salida (Verde)
                        'rgba(33, 150, 243, 0.7)'    // Devueltos Entrada (Azul)
                    ],
                    borderWidth: 1
                }
            ];

            prestamosEstadoChart.update();
        }

        function updateProgramacionCharts() {
            if (!programacionChart) return;

            const db = getDB();

            // Obtener fechas de los pr√≥ximos 30 d√≠as
            const today = new Date();
            const proximosDias = [];
            const proximosDiasLabels = [];

            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);

                const dateStr = date.toISOString().split('T')[0];
                proximosDias.push(dateStr);
                proximosDiasLabels.push(formatShortDate(dateStr));
            }

            // Contar programaciones por d√≠a
            const programacionesPorDia = {};
            proximosDias.forEach(dia => {
                programacionesPorDia[dia] = 0;
            });

            db.programaciones.forEach(prog => {
                if (prog.estado === 'activa' && proximosDias.includes(prog.proximaEntrega)) {
                    programacionesPorDia[prog.proximaEntrega]++;
                }
            });

            // Actualizar gr√°fico
            programacionChart.data.labels = proximosDiasLabels;
            programacionChart.data.datasets = [
                {
                    label: 'Entregas Programadas',
                    data: proximosDias.map(dia => programacionesPorDia[dia]),
                    backgroundColor: 'rgba(33, 150, 243, 0.7)',
                    borderColor: 'rgba(33, 150, 243, 1)',
                    borderWidth: 1
                }
            ];

            programacionChart.update();
        }

        // =========================================
        // UTILITARIOS
        // =========================================

        function formatDate(dateStr) {
            if (!dateStr) return '-';

            const date = new Date(dateStr);
            return date.toLocaleDateString('es-CL');
        }

        function formatShortDate(dateStr) {
            if (!dateStr) return '-';

            const date = new Date(dateStr);
            return date.toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit' });
        }

        function formatShortMonth(monthStr) {
            if (!monthStr) return '-';

            const [year, month] = monthStr.split('-');
            const date = new Date(year, parseInt(month) - 1, 1);

            return date.toLocaleDateString('es-CL', { month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';

            const date = new Date(dateStr);
            return date.toLocaleDateString('es-CL') + ' ' + date.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function calcularProximaFecha(fechaStr, dias) {
            const fecha = new Date(fechaStr);
            fecha.setDate(fecha.getDate() + parseInt(dias));
            return fecha.toISOString().split('T')[0];
        }

        function showLoading() {
            document.getElementById('appLoading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('appLoading').style.display = 'none';
        }

        function showToast(options) {
            const { type, title, message, duration = 5000 } = options;

            const toastContainer = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            let icon = '';
            switch (type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    break;
                case 'danger':
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                    icon = 'fas fa-info-circle';
                    break;
            }

            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div>${message}</div>
                </div>
                <button class="toast-close">&times;</button>
            `;

            toastContainer.appendChild(toast);

            // Activar animaci√≥n
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Configurar cierre
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            });

            // Auto cierre
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toastContainer.removeChild(toast);
                        }
                    }, 300);
                }
            }, duration);
        }

        function exportarDatos() {
            const db = getDB();
            const dataStr = JSON.stringify(db, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = `backup_bodega_${new Date().toISOString().slice(0, 10)}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showToast({
                type: 'success',
                title: 'Exportaci√≥n Exitosa',
                message: 'Se ha exportado correctamente la copia de seguridad'
            });
        }

        function importarDatos() {
            const fileInput = document.getElementById('importarDatosInput');

            if (!fileInput.files || fileInput.files.length === 0) {
                showToast({
                    type: 'warning',
                    title: 'Ning√∫n Archivo Seleccionado',
                    message: 'Por favor, seleccione un archivo para importar'
                });
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                try {
                    const data = JSON.parse(event.target.result);

                    // Verificar que el JSON tiene la estructura correcta
                    if (!data.insumos || !data.personal || !data.entregas ||
                        !data.prestamos || !data.programaciones || !data.configuracion) {
                        throw new Error('El archivo no tiene la estructura de datos correcta');
                    }

                    // Confirmar la importaci√≥n
                    confirmAction(
                        '¬øEst√° seguro de importar estos datos? Esta acci√≥n reemplazar√° todos los datos actuales.',
                        function () {
                            // Guardar los datos importados
                            localStorage.setItem('bodegaDB', JSON.stringify(data));

                            // Recargar los datos
                            loadAllData();

                            // Cargar configuraci√≥n
                            loadConfiguration();

                            // Mostrar notificaci√≥n de √©xito
                            showToast({
                                type: 'success',
                                title: 'Importaci√≥n Exitosa',
                                message: 'Los datos se han importado correctamente'
                            });

                            // Limpiar el input de archivo
                            fileInput.value = '';
                        }
                    );
                } catch (error) {
                    showToast({
                        type: 'danger',
                        title: 'Error de Importaci√≥n',
                        message: error.message || 'El archivo seleccionado no es un backup v√°lido'
                    });
                }
            };

            reader.readAsText(file);
        }

        function exportarReporte() {
            const reporteResultado = document.getElementById('reporteResultado');
            const reporteHTML = reporteResultado.innerHTML;

            // Crear un documento HTML completo para la impresi√≥n
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Reporte - Sistema de Administraci√≥n de Bodega</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        h2, h3 { color: #333; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .text-success { color: #4CAF50; }
                        .text-danger { color: #F44336; }
                    </style>
                </head>
                <body>
                    <h1>Reporte - Sistema de Administraci√≥n de Bodega</h1>
                    <p>Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-CL')}</p>
                    <hr>
                    ${reporteHTML}
                </body>
                </html>
            `;

            // Convertir a data URI
            const dataUri = 'data:text/html;charset=utf-8,' + encodeURIComponent(htmlContent);

            // Nombre de archivo
            const exportFileDefaultName = `reporte_bodega_${new Date().toISOString().slice(0, 10)}.html`;

            // Crear enlace temporal y descargarlo
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showToast({
                type: 'success',
                title: 'Exportaci√≥n Exitosa',
                message: 'Se ha exportado correctamente el reporte'
            });
        }

        function imprimirReporte() {
            const reporteResultado = document.getElementById('reporteResultado');
            const reporteHTML = reporteResultado.innerHTML;

            // Crear una ventana temporal para imprimir
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Reporte - Sistema de Administraci√≥n de Bodega</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        h2, h3 { color: #333; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .text-success { color: #4CAF50; }
                        .text-danger { color: #F44336; }
                        
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Reporte - Sistema de Administraci√≥n de Bodega</h1>
                    <p>Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-CL')}</p>
                    <hr>
                    ${reporteHTML}
                    <div class="no-print">
                        <hr>
                        <button onclick="window.print();">Imprimir</button>
                        <button onclick="window.close();">Cerrar</button>
                    </div>
                </body>
                </html>
            `);

            // Cerrar el documento
            printWindow.document.close();

            // Enfocar la ventana
            printWindow.focus();

            // Imprimir despu√©s de un retraso para asegurar que el contenido se haya cargado
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // =========================================
        // FUNCIONES DE CARGA DE DATOS
        // =========================================

        function loadDashboardData() {
            const db = getDB();

            // Contadores
            document.getElementById('totalInsumos').textContent = db.insumos.reduce((sum, i) => sum + i.stock, 0);

            const insumosBajoStock = db.insumos.filter(i => i.stock < i.stockMinimo);
            document.getElementById('totalAlertas').textContent = insumosBajoStock.length;

            const entregasMes = db.entregas.filter(e => {
                const fecha = new Date(e.fecha);
                const hoy = new Date();
                return fecha.getMonth() === hoy.getMonth() &&
                    fecha.getFullYear() === hoy.getFullYear() &&
                    e.tipo === 'entrega';
            });
            document.getElementById('totalEntregas').textContent = entregasMes.length;

            document.getElementById('totalAseadores').textContent = db.personal.filter(p => p.estado === 'activo').length;

            // Tendencias (simulaci√≥n)
            document.getElementById('insumosTendencia').textContent = '5%';
            document.getElementById('alertasTendencia').textContent = '12%';
            document.getElementById('entregasTendencia').textContent = '8%';
            document.getElementById('aseadoresTendencia').textContent = '3%';

            // Tabla de alertas
            renderAlertasTable(insumosBajoStock);
            renderAlertasList(insumosBajoStock);

            // Tabla de entregas programadas
            const hoy = new Date().toISOString().split('T')[0];
            const programadasHoy = db.programaciones.filter(p => p.proximaEntrega === hoy && p.estado === 'activa');

            renderProgramadasTable(programadasHoy);
            renderProgramadasList(programadasHoy);

            // Actualizar gr√°fico de actividad
            if (actividadChart) {
                updateDashboardCharts();
            }
        }

        function loadInventoryData() {
            const db = getDB();

            renderInventarioTable(db.insumos);
            renderInventarioList(db.insumos);

            updateEntregasInsumoSelect();
            updateRecepcionInsumoSelect();
            updatePrestamoInsumoSelect();
            updateProgramacionInsumoSelect();

            // Actualizar gr√°fico de categor√≠as
            if (inventarioCategoriaChart) {
                updateInventarioCharts();
            }
        }

        function loadPersonalData() {
            const db = getDB();

            renderPersonalTable(db.personal);
            renderPersonalList(db.personal);

            updateEntregasAseadorSelect();
            updateProgramacionAseadorSelect();

            // Actualizar gr√°fico de insumos por aseador
            if (personalInsumosChart) {
                updatePersonalCharts();
            }
        }

        function loadEntregasData() {
            const db = getDB();

            renderEntregasTable(db.entregas);
            renderEntregasList(db.entregas);

            // Actualizar gr√°fico de entregas
            if (entregasChart) {
                updateEntregasCharts();
            }
        }

        function loadPrestamosData() {
            const db = getDB();

            renderPrestamosTable(db.prestamos);
            renderPrestamosList(db.prestamos);

            updateDevolucionPrestamoSelect();

            // Actualizar gr√°fico de estado de pr√©stamos
            if (prestamosEstadoChart) {
                updatePrestamosCharts();
            }
        }

        function loadProgramacionData() {
            const db = getDB();

            renderProgramacionTable(db.programaciones);
            renderProgramacionList(db.programaciones);

            // Actualizar gr√°fico de programaci√≥n
            if (programacionChart) {
                updateProgramacionCharts();
            }
        }

        // =========================================
        // FUNCIONES DE RENDERIZADO
        // =========================================

        function renderAlertasTable(insumos) {
            const tbody = document.getElementById('alertasTableBody');
            tbody.innerHTML = '';

            if (insumos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay alertas de stock bajo</td></tr>';
                return;
            }

            insumos.forEach(insumo => {
                tbody.innerHTML += `
                    <tr>
                        <td>${insumo.nombre}</td>
                        <td class="text-danger font-semibold">${insumo.stock} ${insumo.unidad}</td>
                        <td>${insumo.stockMinimo} ${insumo.unidad}</td>
                        <td><span class="badge badge-danger">Bajo Stock</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="openModal('modalRecepcion', { mode: 'new', insumoId: ${insumo.id} })">
                                <i class="fas fa-plus"></i> Reponer
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderAlertasList(insumos) {
            const list = document.getElementById('alertasList');
            list.innerHTML = '';

            if (insumos.length === 0) {
                list.innerHTML = '<div class="text-center">No hay alertas de stock bajo</div>';
                return;
            }

            insumos.forEach(insumo => {
                const dataItem = document.createElement('div');
                dataItem.className = 'data-item';
                dataItem.innerHTML = `
                    <div class="data-item-header">
                        <div class="data-item-title">
                            ${insumo.nombre}
                            <span class="badge badge-danger">Bajo Stock</span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="data-item-content">
                        <div class="data-item-row">
                            <div class="data-item-label">Stock Actual</div>
                            <div class="data-item-value text-danger font-semibold">${insumo.stock} ${insumo.unidad}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Stock M√≠nimo</div>
                            <div class="data-item-value">${insumo.stockMinimo} ${insumo.unidad}</div>
                        </div>
                        <div class="data-item-actions">
                            <button class="btn btn-sm btn-warning" onclick="openModal('modalRecepcion', { mode: 'new', insumoId: ${insumo.id} })">
                                <i class="fas fa-plus"></i> Reponer
                            </button>
                        </div>
                    </div>
                `;

                list.appendChild(dataItem);
                setupDataItem(dataItem);
            });
        }

        function renderProgramadasTable(programaciones) {
            const db = getDB();
            const tbody = document.getElementById('programadasTableBody');
            tbody.innerHTML = '';

            if (programaciones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay entregas programadas para hoy</td></tr>';
                return;
            }

            programaciones.forEach(prog => {
                const aseador = db.personal.find(p => p.id === prog.aseadorId);
                const insumo = db.insumos.find(i => i.id === prog.insumoId);

                tbody.innerHTML += `
                    <tr>
                        <td>${aseador ? aseador.nombre : 'Desconocido'}</td>
                        <td>${insumo ? insumo.nombre : 'Desconocido'}</td>
                        <td>${prog.cantidad} ${insumo ? insumo.unidad : 'unidades'}</td>
                        <td><span class="badge badge-info">Programada</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="entregarProgramacion(${prog.id})">
                                <i class="fas fa-check"></i> Entregar
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderProgramadasList(programaciones) {
            const db = getDB();
            const list = document.getElementById('programadasList');
            list.innerHTML = '';

            if (programaciones.length === 0) {
                list.innerHTML = '<div class="text-center">No hay entregas programadas para hoy</div>';
                return;
            }

            programaciones.forEach(prog => {
                const aseador = db.personal.find(p => p.id === prog.aseadorId);
                const insumo = db.insumos.find(i => i.id === prog.insumoId);

                const dataItem = document.createElement('div');
                dataItem.className = 'data-item';
                dataItem.innerHTML = `
            <div class="data-item-header">
                <div class="data-item-title">
                    ${aseador ? aseador.nombre : 'Desconocido'}
                    <span class="badge badge-info">Programada</span>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="data-item-content">
                <div class="data-item-row">
                    <div class="data-item-label">Insumo</div>
                    <div class="data-item-value">${insumo ? insumo.nombre : 'Desconocido'}</div>
                </div>
                <div class="data-item-row">
                    <div class="data-item-label">Cantidad</div>
                    <div class="data-item-value">${prog.cantidad} ${insumo ? insumo.unidad : 'unidades'}</div>
                </div>
                <div class="data-item-actions">
                    <button class="btn btn-sm btn-success" onclick="entregarProgramacion(${prog.id})">
                        <i class="fas fa-check"></i> Entregar
                    </button>
                </div>
            </div>
        `;

                list.appendChild(dataItem);
                setupDataItem(dataItem);
            });
        }

        function renderInventarioTable(insumos) {
            const tbody = document.getElementById('inventarioTableBody');
            tbody.innerHTML = '';

            if (insumos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay insumos registrados</td></tr>';
                return;
            }

            insumos.forEach(insumo => {
                const stockClass = insumo.stock < insumo.stockMinimo ? 'text-danger' : 'text-success';

                tbody.innerHTML += `
                    <tr>
                        <td>${insumo.nombre}</td>
                        <td>${capitalize(insumo.categoria)}</td>
                        <td class="${stockClass} font-semibold">${insumo.stock} ${insumo.unidad}</td>
                        <td>${insumo.stockMinimo} ${insumo.unidad}</td>
                        <td>${formatDate(insumo.ultimaActualizacion)}</td>
                        <td>
                            <button class="btn btn-sm btn-light" onclick="openModal('modalInsumo', { mode: 'edit', id: ${insumo.id} })">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteInsumo(${insumo.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderInventarioList(insumos) {
            const list = document.getElementById('inventarioList');
            list.innerHTML = '';

            if (insumos.length === 0) {
                list.innerHTML = '<div class="text-center">No hay insumos registrados</div>';
                return;
            }

            insumos.forEach(insumo => {
                const stockClass = insumo.stock < insumo.stockMinimo ? 'text-danger' : 'text-success';

                const dataItem = document.createElement('div');
                dataItem.className = 'data-item';
                dataItem.innerHTML = `
                    <div class="data-item-header">
                        <div class="data-item-title">
                            ${insumo.nombre}
                            <span class="badge ${insumo.stock < insumo.stockMinimo ? 'badge-danger' : 'badge-success'}">
                                ${insumo.stock < insumo.stockMinimo ? 'Bajo Stock' : 'Stock OK'}
                            </span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="data-item-content">
                        <div class="data-item-row">
                            <div class="data-item-label">Categor√≠a</div>
                            <div class="data-item-value">${capitalize(insumo.categoria)}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Stock</div>
                            <div class="data-item-value ${stockClass} font-semibold">${insumo.stock} ${insumo.unidad}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Stock M√≠nimo</div>
                            <div class="data-item-value">${insumo.stockMinimo} ${insumo.unidad}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Actualizaci√≥n</div>
                            <div class="data-item-value">${formatDate(insumo.ultimaActualizacion)}</div>
                        </div>
                        <div class="data-item-actions">
                            <button class="btn btn-sm btn-light" onclick="openDetailPanel('insumo', ${insumo.id})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="btn btn-sm btn-light" onclick="openModal('modalInsumo', { mode: 'edit', id: ${insumo.id} })">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>
                `;

                list.appendChild(dataItem);
                setupDataItem(dataItem);
            });
        }

        function renderPersonalTable(personal) {
            const db = getDB();
            const tbody = document.getElementById('personalTableBody');
            tbody.innerHTML = '';

            if (personal.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay personal registrado</td></tr>';
                return;
            }

            personal.forEach(persona => {
                // Contar insumos asignados
                const insumosAsignados = db.entregas
                    .filter(e => e.tipo === 'entrega' && e.aseadorId === persona.id)
                    .reduce((sum, e) => sum + e.insumos.reduce((s, i) => s + i.cantidad, 0), 0);

                tbody.innerHTML += `
                    <tr>
                        <td>${persona.nombre}</td>
                        <td>${persona.area}</td>
                        <td>${formatDate(persona.fechaRegistro)}</td>
                        <td>${insumosAsignados}</td>
                        <td>
                            <span class="badge ${persona.estado === 'activo' ? 'badge-success' : 'badge-danger'}">
                                ${capitalize(persona.estado)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-light" onclick="openModal('modalPersonal', { mode: 'edit', id: ${persona.id} })">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePersonal(${persona.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderPersonalList(personal) {
            const db = getDB();
            const list = document.getElementById('personalList');
            list.innerHTML = '';

            if (personal.length === 0) {
                list.innerHTML = '<div class="text-center">No hay personal registrado</div>';
                return;
            }

            personal.forEach(persona => {
                // Contar insumos asignados
                const insumosAsignados = db.entregas
                    .filter(e => e.tipo === 'entrega' && e.aseadorId === persona.id)
                    .reduce((sum, e) => sum + e.insumos.reduce((s, i) => s + i.cantidad, 0), 0);

                const dataItem = document.createElement('div');
                dataItem.className = 'data-item';
                dataItem.innerHTML = `
                    <div class="data-item-header">
                        <div class="data-item-title">
                            ${persona.nombre}
                            <span class="badge ${persona.estado === 'activo' ? 'badge-success' : 'badge-danger'}">
                                ${capitalize(persona.estado)}
                            </span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="data-item-content">
                        <div class="data-item-row">
                            <div class="data-item-label">√Årea</div>
                            <div class="data-item-value">${persona.area}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Fecha Registro</div>
                            <div class="data-item-value">${formatDate(persona.fechaRegistro)}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Insumos Asignados</div>
                            <div class="data-item-value">${insumosAsignados}</div>
                        </div>
                        <div class="data-item-actions">
                            <button class="btn btn-sm btn-light" onclick="openDetailPanel('personal', ${persona.id})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="btn btn-sm btn-light" onclick="openModal('modalPersonal', { mode: 'edit', id: ${persona.id} })">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>
                `;

                list.appendChild(dataItem);
                setupDataItem(dataItem);
            });
        }

        function renderEntregasTable(entregas) {
            const db = getDB();
            const tbody = document.getElementById('entregasTableBody');
            tbody.innerHTML = '';

            if (entregas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay registros de entregas</td></tr>';
                return;
            }

            // Ordenar por fecha (m√°s reciente primero)
            const entregasOrdenadas = [...entregas].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            entregasOrdenadas.forEach(entrega => {
                let destinatarioOrigen = '';
                if (entrega.tipo === 'entrega') {
                    const aseador = db.personal.find(p => p.id === entrega.aseadorId);
                    destinatarioOrigen = aseador ? aseador.nombre : 'Desconocido';
                } else {
                    destinatarioOrigen = entrega.origen || 'Desconocido';
                }

                // Formatear lista de insumos
                const insumosTexto = entrega.insumos.map(item => {
                    const insumo = db.insumos.find(i => i.id === item.insumoId);
                    return insumo ? `${item.cantidad} ${insumo.nombre}` : 'Insumo desconocido';
                }).join(', ');

                tbody.innerHTML += `
                    <tr>
                        <td>${formatDate(entrega.fecha)}</td>
                        <td>
                            <span class="badge ${entrega.tipo === 'entrega' ? 'badge-info' : 'badge-success'}">
                                ${entrega.tipo === 'entrega' ? 'Entrega' : 'Recepci√≥n'}
                            </span>
                        </td>
                        <td>${destinatarioOrigen}</td>
                        <td>${insumosTexto}</td>
                        <td>${entrega.motivo ? capitalize(entrega.motivo) : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-light" onclick="openDetailPanel('entrega', ${entrega.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEntrega(${entrega.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderEntregasList(entregas) {
            const db = getDB();
            const list = document.getElementById('entregasList');
            list.innerHTML = '';

            if (entregas.length === 0) {
                list.innerHTML = '<div class="text-center">No hay registros de entregas</div>';
                return;
            }

            // Ordenar por fecha (m√°s reciente primero)
            const entregasOrdenadas = [...entregas].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            entregasOrdenadas.forEach(entrega => {
                let destinatarioOrigen = '';
                if (entrega.tipo === 'entrega') {
                    const aseador = db.personal.find(p => p.id === entrega.aseadorId);
                    destinatarioOrigen = aseador ? aseador.nombre : 'Desconocido';
                } else {
                    destinatarioOrigen = entrega.origen || 'Desconocido';
                }

                // Formatear lista de insumos
                const insumosTexto = entrega.insumos.map(item => {
                    const insumo = db.insumos.find(i => i.id === item.insumoId);
                    return insumo ? `${item.cantidad} ${insumo.nombre}` : 'Insumo desconocido';
                }).join(', ');

                const dataItem = document.createElement('div');
                dataItem.className = 'data-item';
                dataItem.innerHTML = `
                    <div class="data-item-header">
                        <div class="data-item-title">
                            ${formatDate(entrega.fecha)}
                            <span class="badge ${entrega.tipo === 'entrega' ? 'badge-info' : 'badge-success'}">
                                ${entrega.tipo === 'entrega' ? 'Entrega' : 'Recepci√≥n'}
                            </span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="data-item-content">
                        <div class="data-item-row">
                            <div class="data-item-label">Destinatario/Origen</div>
                            <div class="data-item-value">${destinatarioOrigen}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Insumos</div>
                            <div class="data-item-value">${insumosTexto}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Motivo</div>
                            <div class="data-item-value">${entrega.motivo ? capitalize(entrega.motivo) : '-'}</div>
                        </div>
                        <div class="data-item-actions">
                            <button class="btn btn-sm btn-light" onclick="openDetailPanel('entrega', ${entrega.id})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </div>
                    </div>
                `;

                list.appendChild(dataItem);
                setupDataItem(dataItem);
            });
        }

        function renderPrestamosTable(prestamos) {
            const db = getDB();
            const tbody = document.getElementById('prestamosTableBody');
            tbody.innerHTML = '';

            if (prestamos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay pr√©stamos registrados</td></tr>';
                return;
            }

            // Ordenar por fecha (m√°s reciente primero)
            const prestamosOrdenados = [...prestamos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            prestamosOrdenados.forEach(prestamo => {
                // Formatear lista de insumos
                const insumosTexto = prestamo.insumos.map(item => {
                    const insumo = db.insumos.find(i => i.id === item.insumoId);
                    return insumo ? `${item.cantidad} ${insumo.nombre}` : 'Insumo desconocido';
                }).join(', ');

                tbody.innerHTML += `
                    <tr>
                        <td>${formatDate(prestamo.fecha)}</td>
                        <td>${prestamo.terminal}</td>
                        <td>
                            <span class="badge ${prestamo.tipo === 'salida' ? 'badge-warning' : 'badge-info'}">
                                ${prestamo.tipo === 'salida' ? 'Entregado' : 'Recibido'}
                            </span>
                        </td>
                        <td>${insumosTexto}</td>
                        <td>
                            <span class="badge ${prestamo.estado === 'pendiente' ? 'badge-warning' : 'badge-success'}">
                                ${capitalize(prestamo.estado)}
                            </span>
                        </td>
                        <td>${prestamo.fechaDevolucionReal ? formatDate(prestamo.fechaDevolucionReal) : (prestamo.fechaDevolucion ? formatDate(prestamo.fechaDevolucion) : '-')}</td>
                        <td>
                            <button class="btn btn-sm btn-light" onclick="openDetailPanel('prestamo', ${prestamo.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${prestamo.estado === 'pendiente' ? `
                                <button class="btn btn-sm btn-success" onclick="openModal('modalDevolucion', { prestamoId: ${prestamo.id} })">
                                    <i class="fas fa-undo"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deletePrestamo(${prestamo.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderPrestamosList(prestamos) {
            const db = getDB();
            const list = document.getElementById('prestamosList');
            list.innerHTML = '';

            if (prestamos.length === 0) {
                list.innerHTML = '<div class="text-center">No hay pr√©stamos registrados</div>';
                return;
            }

            // Ordenar por fecha (m√°s reciente primero)
            const prestamosOrdenados = [...prestamos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            prestamosOrdenados.forEach(prestamo => {
                // Formatear lista de insumos
                const insumosTexto = prestamo.insumos.map(item => {
                    const insumo = db.insumos.find(i => i.id === item.insumoId);
                    return insumo ? `${item.cantidad} ${insumo.nombre}` : 'Insumo desconocido';
                }).join(', ');

                const dataItem = document.createElement('div');
                dataItem.className = 'data-item';
                dataItem.innerHTML = `
                    <div class="data-item-header">
                        <div class="data-item-title">
                            ${prestamo.terminal}
                            <span class="badge ${prestamo.estado === 'pendiente' ? 'badge-warning' : 'badge-success'}">
                                ${capitalize(prestamo.estado)}
                            </span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="data-item-content">
                        <div class="data-item-row">
                            <div class="data-item-label">Fecha</div>
                            <div class="data-item-value">${formatDate(prestamo.fecha)}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Tipo</div>
                            <div class="data-item-value">
                                <span class="badge ${prestamo.tipo === 'salida' ? 'badge-warning' : 'badge-info'}">
                                  ${prestamo.tipo === 'salida' ? 'Entregado' : 'Recibido'}
                                </span>
                            </div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Insumos</div>
                            <div class="data-item-value">${insumosTexto}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Devoluci√≥n</div>
                            <div class="data-item-value">${prestamo.fechaDevolucionReal ? formatDate(prestamo.fechaDevolucionReal) : (prestamo.fechaDevolucion ? formatDate(prestamo.fechaDevolucion) : '-')}</div>
                        </div>
                        <div class="data-item-actions">
                            <button class="btn btn-sm btn-light" onclick="openDetailPanel('prestamo', ${prestamo.id})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            ${prestamo.estado === 'pendiente' ? `
                                <button class="btn btn-sm btn-success" onclick="openModal('modalDevolucion', { prestamoId: ${prestamo.id} })">
                                    <i class="fas fa-undo"></i> Devolver
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;

                list.appendChild(dataItem);
                setupDataItem(dataItem);
            });
        }

        function renderProgramacionTable(programaciones) {
            const db = getDB();
            const tbody = document.getElementById('programacionTableBody');
            tbody.innerHTML = '';

            if (programaciones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay programaciones registradas</td></tr>';
                return;
            }

            programaciones.forEach(prog => {
                const aseador = db.personal.find(p => p.id === prog.aseadorId);
                const insumo = db.insumos.find(i => i.id === prog.insumoId);

                let frecuenciaTexto = '';
                switch (parseInt(prog.frecuencia)) {
                    case 7: frecuenciaTexto = 'Semanal'; break;
                    case 14: frecuenciaTexto = 'Quincenal'; break;
                    case 30: frecuenciaTexto = 'Mensual'; break;
                    case 90: frecuenciaTexto = 'Trimestral'; break;
                    case 180: frecuenciaTexto = 'Semestral'; break;
                    case 365: frecuenciaTexto = 'Anual'; break;
                    default: frecuenciaTexto = `${prog.frecuencia} d√≠as`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${aseador ? aseador.nombre : 'Desconocido'}</td>
                        <td>${insumo ? insumo.nombre : 'Desconocido'}</td>
                        <td>${frecuenciaTexto}</td>
                        <td>${formatDate(prog.ultimaEntrega)}</td>
                        <td>${formatDate(prog.proximaEntrega)}</td>
                        <td>
                            <span class="badge ${prog.estado === 'activa' ? 'badge-success' : 'badge-danger'}">
                                ${capitalize(prog.estado)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-light" onclick="openModal('modalProgramacion', { mode: 'edit', id: ${prog.id} })">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProgramacion(${prog.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderProgramacionList(programaciones) {
            const db = getDB();
            const list = document.getElementById('programacionList');
            list.innerHTML = '';

            if (programaciones.length === 0) {
                list.innerHTML = '<div class="text-center">No hay programaciones registradas</div>';
                return;
            }

            programaciones.forEach(prog => {
                const aseador = db.personal.find(p => p.id === prog.aseadorId);
                const insumo = db.insumos.find(i => i.id === prog.insumoId);

                let frecuenciaTexto = '';
                switch (parseInt(prog.frecuencia)) {
                    case 7: frecuenciaTexto = 'Semanal'; break;
                    case 14: frecuenciaTexto = 'Quincenal'; break;
                    case 30: frecuenciaTexto = 'Mensual'; break;
                    case 90: frecuenciaTexto = 'Trimestral'; break;
                    case 180: frecuenciaTexto = 'Semestral'; break;
                    case 365: frecuenciaTexto = 'Anual'; break;
                    default: frecuenciaTexto = `${prog.frecuencia} d√≠as`;
                }

                const dataItem = document.createElement('div');
                dataItem.className = 'data-item';
                dataItem.innerHTML = `
                    <div class="data-item-header">
                        <div class="data-item-title">
                            ${aseador ? aseador.nombre : 'Desconocido'}
                            <span class="badge ${prog.estado === 'activa' ? 'badge-success' : 'badge-danger'}">
                                ${capitalize(prog.estado)}
                            </span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="data-item-content">
                        <div class="data-item-row">
                            <div class="data-item-label">Insumo</div>
                            <div class="data-item-value">${insumo ? insumo.nombre : 'Desconocido'}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Frecuencia</div>
                            <div class="data-item-value">${frecuenciaTexto}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">√öltima Entrega</div>
                            <div class="data-item-value">${formatDate(prog.ultimaEntrega)}</div>
                        </div>
                        <div class="data-item-row">
                            <div class="data-item-label">Pr√≥xima Entrega</div>
                            <div class="data-item-value">${formatDate(prog.proximaEntrega)}</div>
                        </div>
                        <div class="data-item-actions">
                            <button class="btn btn-sm btn-light" onclick="openDetailPanel('programacion', ${prog.id})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="btn btn-sm btn-light" onclick="openModal('modalProgramacion', { mode: 'edit', id: ${prog.id} })">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>
                `;

                list.appendChild(dataItem);
                setupDataItem(dataItem);
            });
        }

        // =========================================
        // FUNCIONES PARA SELECTORES
        // =========================================

        function updateEntregasAseadorSelect() {
            const db = getDB();
            const select = document.getElementById('entregaAseador');
            if (!select) return;

            // Guardar el valor seleccionado actualmente
            const currentValue = select.value;

            // Reiniciar el select
            select.innerHTML = '<option value="">Seleccionar Aseador</option>';

            // Agregar opciones
            db.personal.filter(p => p.estado === 'activo').forEach(persona => {
                const option = document.createElement('option');
                option.value = persona.id;
                option.textContent = persona.nombre;
                select.appendChild(option);
            });

            // Restaurar el valor seleccionado si existe
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function updateEntregasInsumoSelect() {
            const db = getDB();
            const selects = document.querySelectorAll('.entrega-insumo');
            if (selects.length === 0) return;

            selects.forEach(select => {
                // Guardar el valor seleccionado actualmente
                const currentValue = select.value;

                // Reiniciar el select
                select.innerHTML = '<option value="">Seleccionar Insumo</option>';

                // Agregar opciones
                db.insumos.forEach(insumo => {
                    const option = document.createElement('option');
                    option.value = insumo.id;
                    option.textContent = `${insumo.nombre} (${insumo.stock} ${insumo.unidad})`;
                    select.appendChild(option);
                });

                // Restaurar el valor seleccionado si existe
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        function updateRecepcionInsumoSelect() {
            const db = getDB();
            const selects = document.querySelectorAll('.recepcion-insumo');
            if (selects.length === 0) return;

            selects.forEach(select => {
                // Guardar el valor seleccionado actualmente
                const currentValue = select.value;

                // Reiniciar el select
                select.innerHTML = '<option value="">Seleccionar Insumo</option>';

                // Agregar opciones
                db.insumos.forEach(insumo => {
                    const option = document.createElement('option');
                    option.value = insumo.id;
                    option.textContent = `${insumo.nombre} (${insumo.stock} ${insumo.unidad})`;
                    select.appendChild(option);
                });

                // Restaurar el valor seleccionado si existe
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        function updatePrestamoInsumoSelect() {
            const db = getDB();
            const selects = document.querySelectorAll('.prestamo-insumo');
            if (selects.length === 0) return;

            selects.forEach(select => {
                // Guardar el valor seleccionado actualmente
                const currentValue = select.value;

                // Reiniciar el select
                select.innerHTML = '<option value="">Seleccionar Insumo</option>';

                // Agregar opciones
                db.insumos.forEach(insumo => {
                    const option = document.createElement('option');
                    option.value = insumo.id;
                    option.textContent = `${insumo.nombre} (${insumo.stock} ${insumo.unidad})`;
                    select.appendChild(option);
                });

                // Restaurar el valor seleccionado si existe
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        function updateProgramacionAseadorSelect() {
            const db = getDB();
            const select = document.getElementById('programacionAseador');
            if (!select) return;

            // Guardar el valor seleccionado actualmente
            const currentValue = select.value;

            // Reiniciar el select
            select.innerHTML = '<option value="">Seleccionar Aseador</option>';

            // Agregar opciones
            db.personal.filter(p => p.estado === 'activo').forEach(persona => {
                const option = document.createElement('option');
                option.value = persona.id;
                option.textContent = persona.nombre;
                select.appendChild(option);
            });

            // Restaurar el valor seleccionado si existe
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function updateProgramacionInsumoSelect() {
            const db = getDB();
            const select = document.getElementById('programacionInsumo');
            if (!select) return;

            // Guardar el valor seleccionado actualmente
            const currentValue = select.value;

            // Reiniciar el select
            select.innerHTML = '<option value="">Seleccionar Insumo</option>';

            // Agregar opciones
            db.insumos.forEach(insumo => {
                const option = document.createElement('option');
                option.value = insumo.id;
                option.textContent = `${insumo.nombre} (${insumo.stock} ${insumo.unidad})`;
                select.appendChild(option);
            });

            // Restaurar el valor seleccionado si existe
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function updateDevolucionPrestamoSelect() {
            const db = getDB();
            const select = document.getElementById('devolucionPrestamo');
            if (!select) return;

            // Guardar el valor seleccionado actualmente
            const currentValue = select.value;

            // Reiniciar el select
            select.innerHTML = '<option value="">Seleccionar Pr√©stamo</option>';

            // Filtrar pr√©stamos pendientes
            const prestamosPendientes = db.prestamos.filter(p => p.estado === 'pendiente');

            // Agregar opciones
            prestamosPendientes.forEach(prestamo => {
                // Formatear lista de insumos
                const insumosTexto = prestamo.insumos.map(item => {
                    const insumo = db.insumos.find(i => i.id === item.insumoId);
                    return insumo ? `${item.cantidad} ${insumo.nombre}` : 'Insumo desconocido';
                }).join(', ');

                const option = document.createElement('option');
                option.value = prestamo.id;
                option.textContent = `${prestamo.terminal} - ${formatDate(prestamo.fecha)} - ${insumosTexto}`;
                select.appendChild(option);
            });

            // Restaurar el valor seleccionado si existe
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // =========================================
        // FUNCIONES PARA MODALES Y FORMULARIOS
        // =========================================

        function addInsumoRow(tipo) {
            const container = document.getElementById(`${tipo}InsumosContainer`);
            const rowCount = container.querySelectorAll(`.${tipo}-insumo-row`).length + 1;

            const row = document.createElement('div');
            row.className = `form-row ${tipo}-insumo-row`;
            row.innerHTML = `
                <div class="form-col">
                    <div class="form-control">
                        <label class="form-label" for="${tipo}Insumo${rowCount}">Insumo</label>
                        <select class="form-select ${tipo}-insumo" id="${tipo}Insumo${rowCount}" required>
                            <option value="">Seleccionar Insumo</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-control">
                        <label class="form-label" for="${tipo}Cantidad${rowCount}">Cantidad</label>
                        <input type="number" class="form-input ${tipo}-cantidad" id="${tipo}Cantidad${rowCount}" min="1" value="1" required>
                    </div>
                </div>
                <div class="form-col form-col-action">
                    <div class="form-control">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.${tipo}-insumo-row').remove()">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(row);

            // Actualizar selectores
            switch (tipo) {
                case 'entrega':
                    updateEntregasInsumoSelect();
                    break;
                case 'recepcion':
                    updateRecepcionInsumoSelect();
                    break;
                case 'prestamo':
                    updatePrestamoInsumoSelect();
                    break;
            }
        }

        function setupInsumoModal(options) {
            const { mode, id } = options;
            const title = document.getElementById('modalInsumoTitle');
            const form = document.getElementById('formInsumo');

            // Reiniciar formulario
            form.reset();

            if (mode === 'edit' && id) {
                title.textContent = 'Editar Insumo';

                // Cargar datos del insumo
                const db = getDB();
                const insumo = db.insumos.find(i => i.id === id);

                if (insumo) {
                    document.getElementById('insumoId').value = insumo.id;
                    document.getElementById('insumoNombre').value = insumo.nombre;
                    document.getElementById('insumoCategoria').value = insumo.categoria;
                    document.getElementById('insumoUnidad').value = insumo.unidad;
                    document.getElementById('insumoStock').value = insumo.stock;
                    document.getElementById('insumoStockMinimo').value = insumo.stockMinimo;
                    document.getElementById('insumoVidaUtil').value = insumo.vidaUtil;
                    document.getElementById('insumoNotas').value = insumo.notas || '';
                }
            } else {
                title.textContent = 'Nuevo Insumo';
                document.getElementById('insumoId').value = '';

                // Establecer valores por defecto
                const db = getDB();
                document.getElementById('insumoStockMinimo').value = db.configuracion.stockMinimoPorDefecto;
            }
        }

        function saveInsumo() {
            const form = document.getElementById('formInsumo');

            // Validaci√≥n b√°sica
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const db = getDB();

            const id = document.getElementById('insumoId').value;
            const nombre = document.getElementById('insumoNombre').value.trim();
            const categoria = document.getElementById('insumoCategoria').value;
            const unidad = document.getElementById('insumoUnidad').value;
            const stock = parseInt(document.getElementById('insumoStock').value);
            const stockMinimo = parseInt(document.getElementById('insumoStockMinimo').value);
            const vidaUtil = document.getElementById('insumoVidaUtil').value;
            const notas = document.getElementById('insumoNotas').value.trim();

            if (id) {
                // Modo edici√≥n
                const index = db.insumos.findIndex(i => i.id === parseInt(id));
                if (index !== -1) {
                    db.insumos[index] = {
                        ...db.insumos[index],
                        nombre,
                        categoria,
                        unidad,
                        stock,
                        stockMinimo,
                        vidaUtil,
                        notas,
                        ultimaActualizacion: new Date().toISOString().split('T')[0]
                    };

                    saveDB(db);
                    showToast({
                        type: 'success',
                        title: 'Insumo Actualizado',
                        message: `El insumo "${nombre}" ha sido actualizado correctamente.`
                    });
                }
            } else {
                // Modo creaci√≥n
                const nuevoInsumo = {
                    id: getNextId(db.insumos),
                    nombre,
                    categoria,
                    unidad,
                    stock,
                    stockMinimo,
                    vidaUtil,
                    notas,
                    ultimaActualizacion: new Date().toISOString().split('T')[0]
                };

                db.insumos.push(nuevoInsumo);
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Insumo Creado',
                    message: `El insumo "${nombre}" ha sido creado correctamente.`
                });
            }

            // Cerrar modal y recargar datos
            closeModal('modalInsumo');
            loadInventoryData();
            loadDashboardData();
        }

        function deleteInsumo(id) {
            confirmAction('¬øEst√°s seguro de eliminar este insumo? Esta acci√≥n no se puede deshacer.', () => {
                const db = getDB();

                // Verificar si el insumo est√° en uso
                const enUso = db.entregas.some(e => e.insumos.some(i => i.insumoId === id)) ||
                    db.prestamos.some(p => p.insumos.some(i => i.insumoId === id)) ||
                    db.programaciones.some(p => p.insumoId === id);

                if (enUso) {
                    showToast({
                        type: 'danger',
                        title: 'No se puede eliminar',
                        message: 'Este insumo est√° siendo utilizado en entregas, pr√©stamos o programaciones.'
                    });
                    return;
                }

                db.insumos = db.insumos.filter(i => i.id !== id);
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Insumo Eliminado',
                    message: 'El insumo ha sido eliminado correctamente.'
                });

                loadInventoryData();
                loadDashboardData();
            });
        }

        function setupEntregaModal(options) {
            const { mode, id } = options;
            const title = document.getElementById('modalEntregaTitle');
            const form = document.getElementById('formEntrega');

            // Reiniciar formulario
            form.reset();

            // Actualizar selectores
            updateEntregasAseadorSelect();

            // Limpiar insumos adicionales
            const container = document.getElementById('entregaInsumosContainer');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            // Fecha por defecto
            document.getElementById('entregaFecha').value = new Date().toISOString().split('T')[0];

            if (mode === 'edit' && id) {
                title.textContent = 'Editar Entrega';

                // Cargar datos de la entrega
                const db = getDB();
                const entrega = db.entregas.find(e => e.id === id && e.tipo === 'entrega');

                if (entrega) {
                    document.getElementById('entregaId').value = entrega.id;
                    document.getElementById('entregaAseador').value = entrega.aseadorId;
                    document.getElementById('entregaFecha').value = entrega.fecha;
                    document.getElementById('entregaMotivo').value = entrega.motivo;
                    document.getElementById('entregaNotas').value = entrega.notas || '';

                    // Cargar insumos
                    for (let i = 0; i < entrega.insumos.length; i++) {
                        if (i > 0) {
                            addInsumoRow('entrega');
                        }

                        document.querySelectorAll('.entrega-insumo')[i].value = entrega.insumos[i].insumoId;
                        document.querySelectorAll('.entrega-cantidad')[i].value = entrega.insumos[i].cantidad;
                    }
                }
            } else {
                title.textContent = 'Nueva Entrega';
                document.getElementById('entregaId').value = '';
                updateEntregasInsumoSelect();
            }
        }

        function saveEntrega() {
            const form = document.getElementById('formEntrega');

            // Validaci√≥n b√°sica
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const db = getDB();

            const id = document.getElementById('entregaId').value;
            const aseadorId = parseInt(document.getElementById('entregaAseador').value);
            const fecha = document.getElementById('entregaFecha').value;
            const motivo = document.getElementById('entregaMotivo').value;
            const notas = document.getElementById('entregaNotas').value.trim();

            // Obtener insumos
            const insumos = [];
            const insumosSelects = document.querySelectorAll('.entrega-insumo');
            const cantidadesInputs = document.querySelectorAll('.entrega-cantidad');

            for (let i = 0; i < insumosSelects.length; i++) {
                const insumoId = parseInt(insumosSelects[i].value);
                const cantidad = parseInt(cantidadesInputs[i].value);

                if (insumoId && cantidad > 0) {
                    insumos.push({ insumoId, cantidad });
                }
            }

            if (insumos.length === 0) {
                showToast({
                    type: 'warning',
                    title: 'Informaci√≥n Incompleta',
                    message: 'Debe seleccionar al menos un insumo'
                });
                return;
            }

            // Verificar stock
            for (const item of insumos) {
                const insumo = db.insumos.find(i => i.id === item.insumoId);
                if (insumo && insumo.stock < item.cantidad) {
                    showToast({
                        type: 'danger',
                        title: 'Stock Insuficiente',
                        message: `No hay suficiente stock de ${insumo.nombre}. Disponible: ${insumo.stock}`
                    });
                    return;
                }
            }

            if (id) {
                // Modo edici√≥n
                const index = db.entregas.findIndex(e => e.id === parseInt(id));
                if (index !== -1) {
                    // Restaurar stock anterior
                    const entregaAnterior = db.entregas[index];
                    for (const item of entregaAnterior.insumos) {
                        const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                        if (insumoIndex !== -1) {
                            db.insumos[insumoIndex].stock += item.cantidad;
                        }
                    }

                    // Actualizar datos
                    db.entregas[index] = {
                        ...db.entregas[index],
                        aseadorId,
                        fecha,
                        motivo,
                        notas,
                        insumos
                    };

                    // Actualizar stock
                    for (const item of insumos) {
                        const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                        if (insumoIndex !== -1) {
                            db.insumos[insumoIndex].stock -= item.cantidad;
                            db.insumos[insumoIndex].ultimaActualizacion = fecha;
                        }
                    }

                    saveDB(db);
                    showToast({
                        type: 'success',
                        title: 'Entrega Actualizada',
                        message: 'La entrega ha sido actualizada correctamente.'
                    });
                }
            } else {
                // Modo creaci√≥n
                const nuevaEntrega = {
                    id: getNextId(db.entregas),
                    tipo: 'entrega',
                    aseadorId,
                    fecha,
                    motivo,
                    notas,
                    insumos
                };

                // Actualizar stock
                for (const item of insumos) {
                    const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                    if (insumoIndex !== -1) {
                        db.insumos[insumoIndex].stock -= item.cantidad;
                        db.insumos[insumoIndex].ultimaActualizacion = fecha;
                    }
                }

                db.entregas.push(nuevaEntrega);
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Entrega Registrada',
                    message: 'La entrega ha sido registrada correctamente.'
                });

                // Comprobar si hay emails configurados y enviar notificaci√≥n
                if (db.configuracion.emailNotificaciones && db.configuracion.notificaciones.entregas && isConnectedToSheets) {
                    const aseador = db.personal.find(p => p.id === aseadorId);
                    const insumosTexto = insumos.map(item => {
                        const insumo = db.insumos.find(i => i.id === item.insumoId);
                        return `${item.cantidad} ${insumo?.nombre || 'Insumo desconocido'}`;
                    }).join(', ');

                    callGoogleScript('sendEmailNotification', {
                        type: 'entrega',
                        emailData: {
                            aseador: aseador?.nombre || 'Desconocido',
                            insumos: insumosTexto
                        }
                    }).catch(console.error);
                }
            }

            // Cerrar modal y recargar datos
            closeModal('modalEntrega');
            loadEntregasData();
            loadInventoryData();
            loadDashboardData();
        }

        function setupRecepcionModal(options) {
            const { mode, id, insumoId } = options;
            const form = document.getElementById('formRecepcion');

            // Reiniciar formulario
            form.reset();

            // Limpiar insumos adicionales
            const container = document.getElementById('recepcionInsumosContainer');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            // Fecha por defecto
            document.getElementById('recepcionFecha').value = new Date().toISOString().split('T')[0];

            if (mode === 'edit' && id) {
                document.getElementById('modalRecepcion').querySelector('.modal-title').textContent = 'Editar Recepci√≥n';

                // Cargar datos de la recepci√≥n
                const db = getDB();
                const recepcion = db.entregas.find(e => e.id === id && e.tipo === 'recepcion');

                if (recepcion) {
                    document.getElementById('recepcionId').value = recepcion.id;
                    document.getElementById('recepcionOrigen').value = recepcion.origen || '';
                    document.getElementById('recepcionFecha').value = recepcion.fecha;
                    document.getElementById('recepcionDocumento').value = recepcion.documento || '';
                    document.getElementById('recepcionNotas').value = recepcion.notas || '';

                    // Cargar insumos
                    for (let i = 0; i < recepcion.insumos.length; i++) {
                        if (i > 0) {
                            addInsumoRow('recepcion');
                        }

                        document.querySelectorAll('.recepcion-insumo')[i].value = recepcion.insumos[i].insumoId;
                        document.querySelectorAll('.recepcion-cantidad')[i].value = recepcion.insumos[i].cantidad;
                    }
                }
            } else {
                document.getElementById('modalRecepcion').querySelector('.modal-title').textContent = 'Nueva Recepci√≥n';
                document.getElementById('recepcionId').value = '';

                // Si viene de la alerta de bajo stock
                if (insumoId) {
                    document.querySelectorAll('.recepcion-insumo')[0].value = insumoId;
                }

                updateRecepcionInsumoSelect();
            }
        }

        function saveRecepcion() {
            const form = document.getElementById('formRecepcion');

            // Validaci√≥n b√°sica
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const db = getDB();

            const id = document.getElementById('recepcionId').value;
            const origen = document.getElementById('recepcionOrigen').value.trim();
            const fecha = document.getElementById('recepcionFecha').value;
            const documento = document.getElementById('recepcionDocumento').value.trim();
            const notas = document.getElementById('recepcionNotas').value.trim();

            // Obtener insumos
            const insumos = [];
            const insumosSelects = document.querySelectorAll('.recepcion-insumo');
            const cantidadesInputs = document.querySelectorAll('.recepcion-cantidad');

            for (let i = 0; i < insumosSelects.length; i++) {
                const insumoId = parseInt(insumosSelects[i].value);
                const cantidad = parseInt(cantidadesInputs[i].value);

                if (insumoId && cantidad > 0) {
                    insumos.push({ insumoId, cantidad });
                }
            }

            if (insumos.length === 0) {
                showToast({
                    type: 'warning',
                    title: 'Informaci√≥n Incompleta',
                    message: 'Debe seleccionar al menos un insumo'
                });
                return;
            }

            if (id) {
                // Modo edici√≥n
                const index = db.entregas.findIndex(e => e.id === parseInt(id));
                if (index !== -1) {
                    // Restaurar stock anterior
                    const recepcionAnterior = db.entregas[index];
                    for (const item of recepcionAnterior.insumos) {
                        const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                        if (insumoIndex !== -1) {
                            db.insumos[insumoIndex].stock -= item.cantidad;
                            // Evitar stock negativo
                            if (db.insumos[insumoIndex].stock < 0) {
                                db.insumos[insumoIndex].stock = 0;
                            }
                        }
                    }

                    // Actualizar datos
                    db.entregas[index] = {
                        ...db.entregas[index],
                        origen,
                        fecha,
                        documento,
                        notas,
                        insumos
                    };

                    // Actualizar stock
                    for (const item of insumos) {
                        const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                        if (insumoIndex !== -1) {
                            db.insumos[insumoIndex].stock += item.cantidad;
                            db.insumos[insumoIndex].ultimaActualizacion = fecha;
                        }
                    }

                    saveDB(db);
                    showToast({
                        type: 'success',
                        title: 'Recepci√≥n Actualizada',
                        message: 'La recepci√≥n ha sido actualizada correctamente.'
                    });
                }
            } else {
                // Modo creaci√≥n
                const nuevaRecepcion = {
                    id: getNextId(db.entregas),
                    tipo: 'recepcion',
                    origen,
                    fecha,
                    documento,
                    notas,
                    insumos
                };

                // Actualizar stock
                for (const item of insumos) {
                    const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                    if (insumoIndex !== -1) {
                        db.insumos[insumoIndex].stock += item.cantidad;
                        db.insumos[insumoIndex].ultimaActualizacion = fecha;
                    }
                }

                db.entregas.push(nuevaRecepcion);
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Recepci√≥n Registrada',
                    message: 'La recepci√≥n ha sido registrada correctamente.'
                });
            }

            // Cerrar modal y recargar datos
            closeModal('modalRecepcion');
            loadEntregasData();
            loadInventoryData();
            loadDashboardData();
        }

        function setupPersonalModal(options) {
            const { mode, id } = options;
            const title = document.getElementById('modalPersonalTitle');
            const form = document.getElementById('formPersonal');

            // Reiniciar formulario
            form.reset();

            if (mode === 'edit' && id) {
                title.textContent = 'Editar Aseador';

                // Cargar datos del personal
                const db = getDB();
                const personal = db.personal.find(p => p.id === id);

                if (personal) {
                    document.getElementById('personalId').value = personal.id;
                    document.getElementById('personalNombre').value = personal.nombre;
                    document.getElementById('personalRut').value = personal.rut || '';
                    document.getElementById('personalArea').value = personal.area;
                    document.getElementById('personalTelefono').value = personal.telefono || '';
                    document.getElementById('personalEmail').value = personal.email || '';
                    document.getElementById('personalEstado').value = personal.estado;
                    document.getElementById('personalNotas').value = personal.notas || '';
                }
            } else {
                title.textContent = 'Nuevo Aseador';
                document.getElementById('personalId').value = '';
                document.getElementById('personalEstado').value = 'activo';
            }
        }

        function savePersonal() {
            const form = document.getElementById('formPersonal');

            // Validaci√≥n b√°sica
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const db = getDB();

            const id = document.getElementById('personalId').value;
            const nombre = document.getElementById('personalNombre').value.trim();
            const rut = document.getElementById('personalRut').value.trim();
            const area = document.getElementById('personalArea').value.trim();
            const telefono = document.getElementById('personalTelefono').value.trim();
            const email = document.getElementById('personalEmail').value.trim();
            const estado = document.getElementById('personalEstado').value;
            const notas = document.getElementById('personalNotas').value.trim();

            if (id) {
                // Modo edici√≥n
                const index = db.personal.findIndex(p => p.id === parseInt(id));
                if (index !== -1) {
                    db.personal[index] = {
                        ...db.personal[index],
                        nombre,
                        rut,
                        area,
                        telefono,
                        email,
                        estado,
                        notas
                    };

                    saveDB(db);
                    showToast({
                        type: 'success',
                        title: 'Aseador Actualizado',
                        message: `El aseador "${nombre}" ha sido actualizado correctamente.`
                    });
                }
            } else {
                // Modo creaci√≥n
                const nuevoPersonal = {
                    id: getNextId(db.personal),
                    nombre,
                    rut,
                    area,
                    telefono,
                    email,
                    estado,
                    notas,
                    fechaRegistro: new Date().toISOString().split('T')[0]
                };

                db.personal.push(nuevoPersonal);
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Aseador Creado',
                    message: `El aseador "${nombre}" ha sido creado correctamente.`
                });
            }

            // Cerrar modal y recargar datos
            closeModal('modalPersonal');
            loadPersonalData();
            loadDashboardData();
            updateEntregasAseadorSelect();
            updateProgramacionAseadorSelect();
        }

        function deletePersonal(id) {
            confirmAction('¬øEst√°s seguro de eliminar este aseador? Se marcar√° como inactivo.', () => {
                const db = getDB();
                const index = db.personal.findIndex(p => p.id === id);

                if (index !== -1) {
                    db.personal[index].estado = 'inactivo';
                    saveDB(db);

                    showToast({
                        type: 'success',
                        title: 'Aseador Inactivado',
                        message: 'El aseador ha sido marcado como inactivo correctamente.'
                    });

                    loadPersonalData();
                    loadDashboardData();
                    updateEntregasAseadorSelect();
                    updateProgramacionAseadorSelect();
                }
            });
        }

        function setupPrestamoModal(options) {
            const { mode, id } = options;
            const title = document.getElementById('modalPrestamoTitle');
            const form = document.getElementById('formPrestamo');

            // Reiniciar formulario
            form.reset();

            // Limpiar insumos adicionales
            const container = document.getElementById('prestamoInsumosContainer');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            // Fecha por defecto
            document.getElementById('prestamoFecha').value = new Date().toISOString().split('T')[0];

            const fechaDevolucion = new Date();
            fechaDevolucion.setDate(fechaDevolucion.getDate() + 15); // 15 d√≠as por defecto
            document.getElementById('prestamoFechaDevolucion').value = fechaDevolucion.toISOString().split('T')[0];

            if (mode === 'edit' && id) {
                title.textContent = 'Editar Pr√©stamo';

                // Cargar datos del pr√©stamo
                const db = getDB();
                const prestamo = db.prestamos.find(p => p.id === id);

                if (prestamo) {
                    document.getElementById('prestamoId').value = prestamo.id;
                    document.getElementById('prestamoTerminal').value = prestamo.terminal;
                    document.getElementById('prestamoFecha').value = prestamo.fecha;
                    document.getElementById('prestamoTipo').value = prestamo.tipo;
                    document.getElementById('prestamoContacto').value = prestamo.contacto || '';
                    document.getElementById('prestamoFechaDevolucion').value = prestamo.fechaDevolucion || '';
                    document.getElementById('prestamoNotas').value = prestamo.notas || '';

                    // Cargar insumos
                    for (let i = 0; i < prestamo.insumos.length; i++) {
                        if (i > 0) {
                            addInsumoRow('prestamo');
                        }

                        document.querySelectorAll('.prestamo-insumo')[i].value = prestamo.insumos[i].insumoId;
                        document.querySelectorAll('.prestamo-cantidad')[i].value = prestamo.insumos[i].cantidad;
                    }
                }
            } else {
                title.textContent = 'Nuevo Pr√©stamo';
                document.getElementById('prestamoId').value = '';
                updatePrestamoInsumoSelect();
            }
        }

        function savePrestamo() {
            const form = document.getElementById('formPrestamo');

            // Validaci√≥n b√°sica
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const db = getDB();

            const id = document.getElementById('prestamoId').value;
            const terminal = document.getElementById('prestamoTerminal').value.trim();
            const fecha = document.getElementById('prestamoFecha').value;
            const tipo = document.getElementById('prestamoTipo').value;
            const contacto = document.getElementById('prestamoContacto').value.trim();
            const fechaDevolucion = document.getElementById('prestamoFechaDevolucion').value;
            const notas = document.getElementById('prestamoNotas').value.trim();

            // Obtener insumos
            const insumos = [];
            const insumosSelects = document.querySelectorAll('.prestamo-insumo');
            const cantidadesInputs = document.querySelectorAll('.prestamo-cantidad');

            for (let i = 0; i < insumosSelects.length; i++) {
                const insumoId = parseInt(insumosSelects[i].value);
                const cantidad = parseInt(cantidadesInputs[i].value);

                if (insumoId && cantidad > 0) {
                    insumos.push({ insumoId, cantidad });
                }
            }

            if (insumos.length === 0) {
                showToast({
                    type: 'warning',
                    title: 'Informaci√≥n Incompleta',
                    message: 'Debe seleccionar al menos un insumo'
                });
                return;
            }

            // Verificar stock si es pr√©stamo saliente
            if (tipo === 'salida') {
                for (const item of insumos) {
                    const insumo = db.insumos.find(i => i.id === item.insumoId);
                    if (insumo && insumo.stock < item.cantidad) {
                        showToast({
                            type: 'danger',
                            title: 'Stock Insuficiente',
                            message: `No hay suficiente stock de ${insumo.nombre}. Disponible: ${insumo.stock}`
                        });
                        return;
                    }
                }
            }

            if (id) {
                // Modo edici√≥n
                const index = db.prestamos.findIndex(p => p.id === parseInt(id));
                if (index !== -1) {
                    const prestamoAnterior = db.prestamos[index];

                    // Restaurar stock anterior
                    if (prestamoAnterior.tipo === 'salida' && prestamoAnterior.estado === 'pendiente') {
                        for (const item of prestamoAnterior.insumos) {
                            const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                            if (insumoIndex !== -1) {
                                db.insumos[insumoIndex].stock += item.cantidad;
                            }
                        }
                    } else if (prestamoAnterior.tipo === 'entrada' && prestamoAnterior.estado === 'pendiente') {
                        for (const item of prestamoAnterior.insumos) {
                            const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                            if (insumoIndex !== -1) {
                                db.insumos[insumoIndex].stock -= item.cantidad;
                                // Evitar stock negativo
                                if (db.insumos[insumoIndex].stock < 0) {
                                    db.insumos[insumoIndex].stock = 0;
                                }
                            }
                        }
                    }

                    // Actualizar datos
                    db.prestamos[index] = {
                        ...db.prestamos[index],
                        terminal,
                        fecha,
                        tipo,
                        contacto,
                        fechaDevolucion,
                        notas,
                        insumos
                    };

                    // Actualizar stock nuevo
                    if (tipo === 'salida' && db.prestamos[index].estado === 'pendiente') {
                        for (const item of insumos) {
                            const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                            if (insumoIndex !== -1) {
                                db.insumos[insumoIndex].stock -= item.cantidad;
                                db.insumos[insumoIndex].ultimaActualizacion = fecha;
                            }
                        }
                    } else if (tipo === 'entrada' && db.prestamos[index].estado === 'pendiente') {
                        for (const item of insumos) {
                            const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                            if (insumoIndex !== -1) {
                                db.insumos[insumoIndex].stock += item.cantidad;
                                db.insumos[insumoIndex].ultimaActualizacion = fecha;
                            }
                        }
                    }

                    saveDB(db);
                    showToast({
                        type: 'success',
                        title: 'Pr√©stamo Actualizado',
                        message: 'El pr√©stamo ha sido actualizado correctamente.'
                    });
                }
            } else {
                // Modo creaci√≥n
                const nuevoPrestamo = {
                    id: getNextId(db.prestamos),
                    terminal,
                    fecha,
                    tipo,
                    contacto,
                    fechaDevolucion,
                    notas,
                    insumos,
                    estado: 'pendiente'
                };

                // Actualizar stock
                if (tipo === 'salida') {
                    for (const item of insumos) {
                        const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                        if (insumoIndex !== -1) {
                            db.insumos[insumoIndex].stock -= item.cantidad;
                            db.insumos[insumoIndex].ultimaActualizacion = fecha;
                        }
                    }
                } else if (tipo === 'entrada') {
                    for (const item of insumos) {
                        const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                        if (insumoIndex !== -1) {
                            db.insumos[insumoIndex].stock += item.cantidad;
                            db.insumos[insumoIndex].ultimaActualizacion = fecha;
                        }
                    }
                }

                db.prestamos.push(nuevoPrestamo);
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Pr√©stamo Registrado',
                    message: 'El pr√©stamo ha sido registrado correctamente.'
                });

                // Comprobar si hay emails configurados y enviar notificaci√≥n
                if (db.configuracion.emailNotificaciones && db.configuracion.notificaciones.prestamos && isConnectedToSheets) {
                    const insumosTexto = insumos.map(item => {
                        const insumo = db.insumos.find(i => i.id === item.insumoId);
                        return `${item.cantidad} ${insumo?.nombre || 'Insumo desconocido'}`;
                    }).join(', ');

                    callGoogleScript('sendEmailNotification', {
                        type: 'prestamo',
                        emailData: {
                            terminal,
                            tipo: tipo === 'salida' ? 'Entregado' : 'Recibido',
                            insumos: insumosTexto,
                            fechaDevolucion: formatDate(fechaDevolucion)
                        }
                    }).catch(console.error);
                }
            }

            // Cerrar modal y recargar datos
            closeModal('modalPrestamo');
            loadPrestamosData();
            loadInventoryData();
            loadDashboardData();
        }

        function setupDevolucionModal(options) {
            const { prestamoId } = options;
            const form = document.getElementById('formDevolucion');

            // Reiniciar formulario
            form.reset();

            // Fecha por defecto
            document.getElementById('devolucionFecha').value = new Date().toISOString().split('T')[0];

            // Si se especifica un pr√©stamo
            if (prestamoId) {
                document.getElementById('devolucionPrestamoId').value = prestamoId;

                const db = getDB();
                const prestamo = db.prestamos.find(p => p.id === prestamoId);

                if (prestamo && document.getElementById('devolucionPrestamo')) {
                    document.getElementById('devolucionPrestamo').value = prestamoId;
                }
            } else {
                document.getElementById('devolucionPrestamoId').value = '';
            }

            // Actualizar selector de pr√©stamos
            updateDevolucionPrestamoSelect();
        }

        function saveDevolucion() {
            const form = document.getElementById('formDevolucion');

            // Validaci√≥n b√°sica
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const db = getDB();

            let prestamoId = document.getElementById('devolucionPrestamoId').value;

            // Si no hay ID preseleccionado, tomar del select
            if (!prestamoId && document.getElementById('devolucionPrestamo')) {
                prestamoId = document.getElementById('devolucionPrestamo').value;
            }

            if (!prestamoId) {
                showToast({
                    type: 'warning',
                    title: 'Informaci√≥n Incompleta',
                    message: 'Debe seleccionar un pr√©stamo'
                });
                return;
            }

            prestamoId = parseInt(prestamoId);
            const fecha = document.getElementById('devolucionFecha').value;
            const notas = document.getElementById('devolucionNotas').value.trim();

            const prestamoIndex = db.prestamos.findIndex(p => p.id === prestamoId);

            if (prestamoIndex === -1) {
                showToast({
                    type: 'danger',
                    title: 'Error',
                    message: 'Pr√©stamo no encontrado'
                });
                return;
            }

            const prestamo = db.prestamos[prestamoIndex];

            // Solo procesar si est√° pendiente
            if (prestamo.estado === 'pendiente') {
                // Actualizar estado
                prestamo.estado = 'devuelto';
                prestamo.fechaDevolucionReal = fecha;

                if (notas) {
                    prestamo.notas = (prestamo.notas ? prestamo.notas + '\n\n' : '') +
                        `Notas de devoluci√≥n (${formatDate(fecha)}): ${notas}`;
                }

                // Si era de salida, devolver insumos al inventario
                if (prestamo.tipo === 'salida') {
                    prestamo.insumos.forEach(item => {
                        const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                        if (insumoIndex !== -1) {
                            db.insumos[insumoIndex].stock += item.cantidad;
                            db.insumos[insumoIndex].ultimaActualizacion = fecha;
                        }
                    });
                }
                // Si era de entrada, quitar insumos del inventario
                else if (prestamo.tipo === 'entrada') {
                    prestamo.insumos.forEach(item => {
                        const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                        if (insumoIndex !== -1) {
                            db.insumos[insumoIndex].stock -= item.cantidad;
                            // Evitar stock negativo
                            if (db.insumos[insumoIndex].stock < 0) {
                                db.insumos[insumoIndex].stock = 0;
                            }
                            db.insumos[insumoIndex].ultimaActualizacion = fecha;
                        }
                    });
                }

                // Guardar cambios
                db.prestamos[prestamoIndex] = prestamo;
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Devoluci√≥n Registrada',
                    message: 'La devoluci√≥n ha sido registrada correctamente.'
                });

                // Recargar datos
                loadPrestamosData();
                loadInventoryData();
                loadDashboardData();

                // Cerrar modal
                closeModal('modalDevolucion');
            } else {
                showToast({
                    type: 'warning',
                    title: 'Pr√©stamo Ya Devuelto',
                    message: 'Este pr√©stamo ya ha sido devuelto.'
                });
            }
        }

        function deletePrestamo(id) {
            confirmAction('¬øEst√°s seguro de eliminar este pr√©stamo? Esta acci√≥n no se puede deshacer.', () => {
                const db = getDB();

                // Buscar pr√©stamo
                const prestamo = db.prestamos.find(p => p.id === id);

                if (prestamo) {
                    // Revertir cambios en el inventario si es necesario
                    if (prestamo.tipo === 'salida' && prestamo.estado === 'pendiente') {
                        // Si es de salida y a√∫n no devuelto, devolver insumos al inventario
                        prestamo.insumos.forEach(item => {
                            const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                            if (insumoIndex !== -1) {
                                db.insumos[insumoIndex].stock += item.cantidad;
                                db.insumos[insumoIndex].ultimaActualizacion = new Date().toISOString().split('T')[0];
                            }
                        });
                    } else if (prestamo.tipo === 'entrada' && prestamo.estado === 'pendiente') {
                        // Si es de entrada y no devuelto, quitar insumos del inventario
                        prestamo.insumos.forEach(item => {
                            const insumoIndex = db.insumos.findIndex(i => i.id === item.insumoId);
                            if (insumoIndex !== -1) {
                                db.insumos[insumoIndex].stock -= item.cantidad;
                                // Evitar stock negativo
                                if (db.insumos[insumoIndex].stock < 0) {
                                    db.insumos[insumoIndex].stock = 0;
                                }
                                db.insumos[insumoIndex].ultimaActualizacion = new Date().toISOString().split('T')[0];
                            }
                        });
                    }

                    // Eliminar pr√©stamo
                    db.prestamos = db.prestamos.filter(p => p.id !== id);

                    // Guardar cambios
                    saveDB(db);

                    showToast({
                        type: 'success',
                        title: 'Pr√©stamo Eliminado',
                        message: 'El pr√©stamo ha sido eliminado correctamente.'
                    });

                    // Recargar datos
                    loadPrestamosData();
                    loadInventoryData();
                    loadDashboardData();
                }
            });
        }

        function setupProgramacionModal(options) {
            const { mode, id } = options;
            const title = document.getElementById('modalProgramacionTitle');
            const form = document.getElementById('formProgramacion');

            // Reiniciar formulario
            form.reset();

            // Actualizar selectores
            updateProgramacionAseadorSelect();
            updateProgramacionInsumoSelect();

            // Fecha por defecto
            document.getElementById('programacionInicio').value = new Date().toISOString().split('T')[0];

            if (mode === 'edit' && id) {
                title.textContent = 'Editar Programaci√≥n';

                // Cargar datos de la programaci√≥n
                const db = getDB();
                const programacion = db.programaciones.find(p => p.id === id);

                if (programacion) {
                    document.getElementById('programacionId').value = programacion.id;
                    document.getElementById('programacionAseador').value = programacion.aseadorId;
                    document.getElementById('programacionInsumo').value = programacion.insumoId;
                    document.getElementById('programacionFrecuencia').value = programacion.frecuencia;
                    document.getElementById('programacionCantidad').value = programacion.cantidad;
                    document.getElementById('programacionInicio').value = programacion.fechaInicio;
                    document.getElementById('programacionFin').value = programacion.fechaFin || '';
                    document.getElementById('programacionNotas').value = programacion.notas || '';
                }
            } else {
                title.textContent = 'Nueva Programaci√≥n';
                document.getElementById('programacionId').value = '';
            }
        }

        function saveProgramacion() {
            const form = document.getElementById('formProgramacion');

            // Validaci√≥n b√°sica
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const db = getDB();

            const id = document.getElementById('programacionId').value;
            const aseadorId = parseInt(document.getElementById('programacionAseador').value);
            const insumoId = parseInt(document.getElementById('programacionInsumo').value);
            const frecuencia = parseInt(document.getElementById('programacionFrecuencia').value);
            const cantidad = parseInt(document.getElementById('programacionCantidad').value);
            const fechaInicio = document.getElementById('programacionInicio').value;
            const fechaFin = document.getElementById('programacionFin').value;
            const notas = document.getElementById('programacionNotas').value.trim();

            // Calcular pr√≥xima entrega
            const proximaEntrega = calcularProximaFecha(fechaInicio, frecuencia);

            if (id) {
                // Modo edici√≥n
                const index = db.programaciones.findIndex(p => p.id === parseInt(id));
                if (index !== -1) {
                    // Si ha cambiado la fecha de inicio o la frecuencia, recalcular pr√≥xima entrega
                    const recalcularProximaEntrega =
                        db.programaciones[index].fechaInicio !== fechaInicio ||
                        db.programaciones[index].frecuencia !== frecuencia;

                    db.programaciones[index] = {
                        ...db.programaciones[index],
                        aseadorId,
                        insumoId,
                        frecuencia,
                        cantidad,
                        fechaInicio,
                        fechaFin,
                        notas,
                        proximaEntrega: recalcularProximaEntrega ? proximaEntrega : db.programaciones[index].proximaEntrega
                    };

                    saveDB(db);
                    showToast({
                        type: 'success',
                        title: 'Programaci√≥n Actualizada',
                        message: 'La programaci√≥n ha sido actualizada correctamente.'
                    });
                }
            } else {
                // Modo creaci√≥n
                const nuevaProgramacion = {
                    id: getNextId(db.programaciones),
                    aseadorId,
                    insumoId,
                    frecuencia,
                    cantidad,
                    fechaInicio,
                    fechaFin,
                    notas,
                    ultimaEntrega: fechaInicio,
                    proximaEntrega,
                    estado: 'activa'
                };

                db.programaciones.push(nuevaProgramacion);
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Programaci√≥n Registrada',
                    message: 'La programaci√≥n ha sido registrada correctamente.'
                });
            }

            // Cerrar modal y recargar datos
            closeModal('modalProgramacion');
            loadProgramacionData();
            loadDashboardData();
        }

        function deleteProgramacion(id) {
            confirmAction('¬øEst√°s seguro de eliminar esta programaci√≥n? Esta acci√≥n no se puede deshacer.', () => {
                const db = getDB();

                // Eliminar programaci√≥n
                db.programaciones = db.programaciones.filter(p => p.id !== id);

                // Guardar cambios
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Programaci√≥n Eliminada',
                    message: 'La programaci√≥n ha sido eliminada correctamente.'
                });

                // Recargar datos
                loadProgramacionData();
                loadDashboardData();
            });
        }

        // =========================================
        // FUNCIONES PARA PANELES DE DETALLE
        // =========================================

        function openDetailPanel(type, id) {
            const detailPanel = document.getElementById('detailPanel');
            const detailPanelTitle = document.getElementById('detailPanelTitle');
            const detailPanelContent = document.getElementById('detailPanelContent');
            const detailActionBtn = document.getElementById('detailActionBtn');

            // Configurar seg√∫n el tipo
            switch (type) {
                case 'insumo':
                    setupInsumoDetailPanel(id, detailPanelTitle, detailPanelContent, detailActionBtn);
                    break;
                case 'personal':
                    setupPersonalDetailPanel(id, detailPanelTitle, detailPanelContent, detailActionBtn);
                    break;
                case 'entrega':
                    setupEntregaDetailPanel(id, detailPanelTitle, detailPanelContent, detailActionBtn);
                    break;
                case 'prestamo':
                    setupPrestamoDetailPanel(id, detailPanelTitle, detailPanelContent, detailActionBtn);
                    break;
                case 'programacion':
                    setupProgramacionDetailPanel(id, detailPanelTitle, detailPanelContent, detailActionBtn);
                    break;
            }

            // Mostrar panel
            detailPanel.classList.add('open');
        }

        function closeDetailPanel() {
            document.getElementById('detailPanel').classList.remove('open');
        }

        function setupInsumoDetailPanel(id, title, content, actionBtn) {
            const db = getDB();
            const insumo = db.insumos.find(i => i.id === id);

            if (!insumo) return;

            title.textContent = insumo.nombre;

            content.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">Categor√≠a</div>
                    <div class="detail-value">${capitalize(insumo.categoria)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Stock</div>
                    <div class="detail-value ${insumo.stock < insumo.stockMinimo ? 'text-danger' : 'text-success'}">
                        ${insumo.stock} ${insumo.unidad}
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Stock M√≠nimo</div>
                    <div class="detail-value">${insumo.stockMinimo} ${insumo.unidad}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Vida √ötil</div>
                    <div class="detail-value">${getVidaUtilText(insumo.vidaUtil)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">√öltima Actualizaci√≥n</div>
                    <div class="detail-value">${formatDate(insumo.ultimaActualizacion)}</div>
                </div>
                ${insumo.notas ? `
                <div class="detail-group">
                    <div class="detail-label">Notas</div>
                    <div class="detail-value">${insumo.notas}</div>
                </div>
                ` : ''}`;

            actionBtn.textContent = 'Editar';
            actionBtn.onclick = () => {
                closeDetailPanel();
                openModal('modalInsumo', { mode: 'edit', id });
            };
        }

        function getVidaUtilText(vidaUtil) {
            if (vidaUtil === 'indefinido') return 'Indefinido';

            const dias = parseInt(vidaUtil);
            if (dias === 7) return '1 semana';
            if (dias === 14) return '2 semanas';
            if (dias === 30) return '1 mes';
            if (dias === 90) return '3 meses';
            if (dias === 180) return '6 meses';
            if (dias === 365) return '1 a√±o';

            return `${dias} d√≠as`;
        }

        function setupPersonalDetailPanel(id, title, content, actionBtn) {
            const db = getDB();
            const persona = db.personal.find(p => p.id === id);

            if (!persona) return;

            title.textContent = persona.nombre;

            // Contar insumos asignados
            const insumosAsignados = db.entregas
                .filter(e => e.tipo === 'entrega' && e.aseadorId === persona.id)
                .reduce((sum, e) => sum + e.insumos.reduce((s, i) => s + i.cantidad, 0), 0);

            content.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">RUT</div>
                    <div class="detail-value">${persona.rut || '-'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">√Årea</div>
                    <div class="detail-value">${persona.area}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Tel√©fono</div>
                    <div class="detail-value">${persona.telefono || '-'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${persona.email || '-'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Estado</div>
                    <div class="detail-value">
                        <span class="badge ${persona.estado === 'activo' ? 'badge-success' : 'badge-danger'}">
                            ${capitalize(persona.estado)}
                        </span>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Fecha de Registro</div>
                    <div class="detail-value">${formatDate(persona.fechaRegistro)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Insumos Asignados</div>
                    <div class="detail-value">${insumosAsignados}</div>
                </div>
                ${persona.notas ? `
                <div class="detail-group">
                    <div class="detail-label">Notas</div>
                    <div class="detail-value">${persona.notas}</div>
                </div>
                ` : ''}
            `;

            actionBtn.textContent = 'Editar';
            actionBtn.onclick = () => {
                closeDetailPanel();
                openModal('modalPersonal', { mode: 'edit', id });
            };
        }

        function setupEntregaDetailPanel(id, title, content, actionBtn) {
            const db = getDB();
            const entrega = db.entregas.find(e => e.id === id);

            if (!entrega) return;

            let destinatarioOrigen = '';
            if (entrega.tipo === 'entrega') {
                const aseador = db.personal.find(p => p.id === entrega.aseadorId);
                destinatarioOrigen = aseador ? aseador.nombre : 'Desconocido';
                title.textContent = `Entrega a ${destinatarioOrigen}`;
            } else {
                destinatarioOrigen = entrega.origen || 'Desconocido';
                title.textContent = `Recepci√≥n de ${destinatarioOrigen}`;
            }

            // Formatear lista de insumos
            const insumosTexto = entrega.insumos.map(item => {
                const insumo = db.insumos.find(i => i.id === item.insumoId);
                return insumo ? `${item.cantidad} ${insumo.nombre}` : 'Insumo desconocido';
            }).join('<br>');

            content.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">Fecha</div>
                    <div class="detail-value">${formatDate(entrega.fecha)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Tipo</div>
                    <div class="detail-value">
                        <span class="badge ${entrega.tipo === 'entrega' ? 'badge-info' : 'badge-success'}">
                            ${entrega.tipo === 'entrega' ? 'Entrega' : 'Recepci√≥n'}
                        </span>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">${entrega.tipo === 'entrega' ? 'Destinatario' : 'Origen'}</div>
                    <div class="detail-value">${destinatarioOrigen}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Insumos</div>
                    <div class="detail-value">${insumosTexto}</div>
                </div>
                ${entrega.tipo === 'entrega' ? `
                <div class="detail-group">
                    <div class="detail-label">Motivo</div>
                    <div class="detail-value">${entrega.motivo ? capitalize(entrega.motivo) : '-'}</div>
                </div>
                ` : ''}
                ${entrega.tipo === 'recepcion' && entrega.documento ? `
                <div class="detail-group">
                    <div class="detail-label">Documento</div>
                    <div class="detail-value">${entrega.documento}</div>
                </div>
                ` : ''}
                ${entrega.notas ? `
                <div class="detail-group">
                    <div class="detail-label">Notas</div>
                    <div class="detail-value">${entrega.notas}</div>
                </div>
                ` : ''}
            `;

            actionBtn.textContent = 'Editar';
            actionBtn.onclick = () => {
                closeDetailPanel();
                if (entrega.tipo === 'entrega') {
                    openModal('modalEntrega', { mode: 'edit', id });
                } else {
                    openModal('modalRecepcion', { mode: 'edit', id });
                }
            };
        }

        function setupPrestamoDetailPanel(id, title, content, actionBtn) {
            const db = getDB();
            const prestamo = db.prestamos.find(p => p.id === id);

            if (!prestamo) return;

            title.textContent = `Pr√©stamo a ${prestamo.terminal}`;

            // Formatear lista de insumos
            const insumosTexto = prestamo.insumos.map(item => {
                const insumo = db.insumos.find(i => i.id === item.insumoId);
                return insumo ? `${item.cantidad} ${insumo.nombre}` : 'Insumo desconocido';
            }).join('<br>');

            content.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">Fecha</div>
                    <div class="detail-value">${formatDate(prestamo.fecha)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Tipo</div>
                    <div class="detail-value">
                        <span class="badge ${prestamo.tipo === 'salida' ? 'badge-warning' : 'badge-info'}">
                            ${prestamo.tipo === 'salida' ? 'Entregado' : 'Recibido'}
                        </span>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Estado</div>
                    <div class="detail-value">
                        <span class="badge ${prestamo.estado === 'pendiente' ? 'badge-warning' : 'badge-success'}">
                            ${capitalize(prestamo.estado)}
                        </span>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Contacto</div>
                    <div class="detail-value">${prestamo.contacto || '-'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Insumos</div>
                    <div class="detail-value">${insumosTexto}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Fecha Devoluci√≥n Estimada</div>
                    <div class="detail-value">${prestamo.fechaDevolucion ? formatDate(prestamo.fechaDevolucion) : '-'}</div>
                </div>
                ${prestamo.fechaDevolucionReal ? `
                <div class="detail-group">
                    <div class="detail-label">Fecha Devoluci√≥n Real</div>
                    <div class="detail-value">${formatDate(prestamo.fechaDevolucionReal)}</div>
                </div>
                ` : ''}
                ${prestamo.notas ? `
                <div class="detail-group">
                    <div class="detail-label">Notas</div>
                    <div class="detail-value">${prestamo.notas}</div>
                </div>
                ` : ''}
            `;

            if (prestamo.estado === 'pendiente') {
                actionBtn.textContent = 'Registrar Devoluci√≥n';
                actionBtn.onclick = () => {
                    closeDetailPanel();
                    openModal('modalDevolucion', { prestamoId: prestamo.id });
                };
            } else {
                actionBtn.textContent = 'Editar';
                actionBtn.onclick = () => {
                    closeDetailPanel();
                    openModal('modalPrestamo', { mode: 'edit', id });
                };
            }
        }

        function setupProgramacionDetailPanel(id, title, content, actionBtn) {
            const db = getDB();
            const prog = db.programaciones.find(p => p.id === id);

            if (!prog) return;

            const aseador = db.personal.find(p => p.id === prog.aseadorId);
            const insumo = db.insumos.find(i => i.id === prog.insumoId);

            title.textContent = `Programaci√≥n ${aseador ? 'para ' + aseador.nombre : ''}`;

            let frecuenciaTexto = '';
            switch (parseInt(prog.frecuencia)) {
                case 7: frecuenciaTexto = 'Semanal'; break;
                case 14: frecuenciaTexto = 'Quincenal'; break;
                case 30: frecuenciaTexto = 'Mensual'; break;
                case 90: frecuenciaTexto = 'Trimestral'; break;
                case 180: frecuenciaTexto = 'Semestral'; break;
                case 365: frecuenciaTexto = 'Anual'; break;
                default: frecuenciaTexto = `Cada ${prog.frecuencia} d√≠as`;
            }

            content.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">Aseador</div>
                    <div class="detail-value">${aseador ? aseador.nombre : 'Desconocido'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Insumo</div>
                    <div class="detail-value">${insumo ? insumo.nombre : 'Desconocido'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Cantidad</div>
                    <div class="detail-value">${prog.cantidad} ${insumo ? insumo.unidad : 'unidades'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Frecuencia</div>
                    <div class="detail-value">${frecuenciaTexto}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Fecha Inicio</div>
                    <div class="detail-value">${formatDate(prog.fechaInicio)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Fecha Fin</div>
                    <div class="detail-value">${prog.fechaFin ? formatDate(prog.fechaFin) : 'Indefinido'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">√öltima Entrega</div>
                    <div class="detail-value">${formatDate(prog.ultimaEntrega)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Pr√≥xima Entrega</div>
                    <div class="detail-value">${formatDate(prog.proximaEntrega)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Estado</div>
                    <div class="detail-value">
                        <span class="badge ${prog.estado === 'activa' ? 'badge-success' : 'badge-danger'}">
                            ${capitalize(prog.estado)}
                        </span>
                    </div>
                </div>
                ${prog.notas ? `
                <div class="detail-group">
                    <div class="detail-label">Notas</div>
                    <div class="detail-value">${prog.notas}</div>
                </div>
                ` : ''}
            `;

            const hoy = new Date().toISOString().split('T')[0];

            if (prog.proximaEntrega === hoy && prog.estado === 'activa') {
                actionBtn.textContent = 'Entregar Ahora';
                actionBtn.onclick = () => {
                    closeDetailPanel();
                    entregarProgramacion(prog.id);
                };
            } else {
                actionBtn.textContent = 'Editar';
                actionBtn.onclick = () => {
                    closeDetailPanel();
                    openModal('modalProgramacion', { mode: 'edit', id });
                };
            }
        }

        // =========================================
        // FUNCIONES PARA ENTREGAS PROGRAMADAS
        // =========================================

        function entregarProgramacion(id) {
            const db = getDB();
            const programacion = db.programaciones.find(p => p.id === id);

            if (!programacion) {
                showToast({
                    type: 'danger',
                    title: 'Error',
                    message: 'Programaci√≥n no encontrada'
                });
                return;
            }

            const insumo = db.insumos.find(i => i.id === programacion.insumoId);

            // Verificar stock
            if (insumo && insumo.stock < programacion.cantidad) {
                showToast({
                    type: 'danger',
                    title: 'Stock Insuficiente',
                    message: `No hay suficiente stock de ${insumo.nombre}. Disponible: ${insumo.stock}`
                });
                return;
            }

            confirmAction('¬øEst√° seguro de realizar esta entrega programada?', () => {
                const hoy = new Date().toISOString().split('T')[0];

                // Crear entrega
                const nuevaEntrega = {
                    id: getNextId(db.entregas),
                    tipo: 'entrega',
                    aseadorId: programacion.aseadorId,
                    fecha: hoy,
                    motivo: 'reposicion',
                    notas: `Entrega programada autom√°tica (ID: ${programacion.id})`,
                    insumos: [{ insumoId: programacion.insumoId, cantidad: programacion.cantidad }]
                };

                // Actualizar stock
                const insumoIndex = db.insumos.findIndex(i => i.id === programacion.insumoId);
                if (insumoIndex !== -1) {
                    db.insumos[insumoIndex].stock -= programacion.cantidad;
                    db.insumos[insumoIndex].ultimaActualizacion = hoy;
                }

                // Actualizar programaci√≥n
                const programacionIndex = db.programaciones.findIndex(p => p.id === programacion.id);
                if (programacionIndex !== -1) {
                    db.programaciones[programacionIndex].ultimaEntrega = hoy;
                    db.programaciones[programacionIndex].proximaEntrega = calcularProximaFecha(hoy, programacion.frecuencia);
                }

                // Guardar cambios
                db.entregas.push(nuevaEntrega);
                saveDB(db);

                showToast({
                    type: 'success',
                    title: 'Entrega Realizada',
                    message: 'La entrega programada ha sido realizada correctamente.'
                });

                // Recargar datos
                loadProgramacionData();
                loadEntregasData();
                loadInventoryData();
                loadDashboardData();
            });
        }

        // =========================================
        // FUNCIONES PARA CONFIGURACI√ìN
        // =========================================

        function saveConfiguracion() {
            const db = getDB();

            db.configuracion.nombreEmpresa = document.getElementById('configNombreEmpresa').value.trim() || 'Empresa';
            db.configuracion.stockMinimoPorDefecto = parseInt(document.getElementById('configStockMinimo').value) || 10;

            saveDB(db);

            showToast({
                type: 'success',
                title: 'Configuraci√≥n Guardada',
                message: 'La configuraci√≥n general ha sido guardada correctamente.'
            });
        }

        function saveNotificaciones() {
            const db = getDB();

            db.configuracion.emailNotificaciones = document.getElementById('configEmailDestinatario').value.trim();
            db.configuracion.notificaciones = {
                bajoStock: document.getElementById('notifBajoStock').checked,
                entregas: document.getElementById('notifEntregas').checked,
                prestamos: document.getElementById('notifPrestamos').checked
            };

            saveDB(db);

            showToast({
                type: 'success',
                title: 'Configuraci√≥n Guardada',
                message: 'La configuraci√≥n de notificaciones ha sido guardada correctamente.'
            });
        }

        function conectarGoogleSheets() {
            const scriptUrl = document.getElementById('configScriptUrl').value.trim();

            if (!scriptUrl) {
                showToast({
                    type: 'warning',
                    title: 'URL No V√°lida',
                    message: 'Debe ingresar la URL del script web'
                });
                return;
            }

            // Actualizar la URL del script
            GOOGLE_SCRIPT_URL = scriptUrl;

            // Guardar en la configuraci√≥n
            const db = getDB();
            db.configuracion.scriptUrl = scriptUrl;
            localStorage.setItem('bodegaDB', JSON.stringify(db));

            // Probar la conexi√≥n
            checkSheetsConnection();
        }

        // =========================================
        // FUNCIONES PARA REPORTES
        // =========================================

        function generarReporte() {
            showLoading();

            const tipoReporte = document.getElementById('reporteTipo').value;
            const periodo = document.getElementById('reportePeriodo').value;

            // Determinar fechas del reporte
            let fechaInicio, fechaFin;
            const hoy = new Date();

            switch (periodo) {
                case 'semana':
                    fechaInicio = new Date(hoy);
                    fechaInicio.setDate(hoy.getDate() - 7);
                    fechaFin = hoy;
                    break;
                case 'mes':
                    fechaInicio = new Date(hoy);
                    fechaInicio.setMonth(hoy.getMonth() - 1);
                    fechaFin = hoy;
                    break;
                case 'trimestre':
                    fechaInicio = new Date(hoy);
                    fechaInicio.setMonth(hoy.getMonth() - 3);
                    fechaFin = hoy;
                    break;
                case 'anual':
                    fechaInicio = new Date(hoy);
                    fechaInicio.setFullYear(hoy.getFullYear() - 1);
                    fechaFin = hoy;
                    break;
                case 'personalizado':
                    fechaInicio = new Date(document.getElementById('reporteFechaInicio').value);
                    fechaFin = new Date(document.getElementById('reporteFechaFin').value);
                    break;
            }

            // Formatear fechas para comparaci√≥n
            const fechaInicioStr = fechaInicio.toISOString().split('T')[0];
            const fechaFinStr = fechaFin.toISOString().split('T')[0];

            const db = getDB();
            const resultadoDiv = document.getElementById('reporteResultado');

            // Generar reporte seg√∫n tipo
            switch (tipoReporte) {
                case 'inventario':
                    resultadoDiv.innerHTML = generarReporteInventario(db);
                    break;
                case 'movimientos':
                    resultadoDiv.innerHTML = generarReporteMovimientos(db, fechaInicioStr, fechaFinStr);
                    break;
                case 'entregas':
                    resultadoDiv.innerHTML = generarReporteEntregas(db, fechaInicioStr, fechaFinStr);
                    break;
                case 'consumo':
                    resultadoDiv.innerHTML = generarReporteConsumo(db, fechaInicioStr, fechaFinStr);
                    break;
                case 'prestamos':
                    resultadoDiv.innerHTML = generarReportePrestamos(db, fechaInicioStr, fechaFinStr);
                    break;
            }

            hideLoading();

            // Scroll al resultado
            document.getElementById('reporteResultado').scrollIntoView({ behavior: 'smooth' });
        }

        function generarReporteInventario(db) {
            let html = `
                <h3>Reporte de Inventario Actual</h3>
                <p>Fecha de generaci√≥n: ${formatDate(new Date().toISOString().split('T')[0])}</p>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Insumo</th>
                                <th>Categor√≠a</th>
                                <th>Stock</th>
                                <th>Stock M√≠nimo</th>
                                <th>Estado</th>
                                <th>√öltima Actualizaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Ordenar insumos por categor√≠a y nombre
            const insumosOrdenados = [...db.insumos].sort((a, b) => {
                if (a.categoria !== b.categoria) {
                    return a.categoria.localeCompare(b.categoria);
                }
                return a.nombre.localeCompare(b.nombre);
            });

            insumosOrdenados.forEach(insumo => {
                const estado = insumo.stock < insumo.stockMinimo ? 'Bajo' : 'Normal';
                const estadoClass = insumo.stock < insumo.stockMinimo ? 'text-danger' : 'text-success';

                html += `
                    <tr>
                        <td>${insumo.nombre}</td>
                        <td>${capitalize(insumo.categoria)}</td>
                        <td class="${estadoClass} font-semibold">${insumo.stock} ${insumo.unidad}</td>
                        <td>${insumo.stockMinimo} ${insumo.unidad}</td>
                        <td class="${estadoClass}">${estado}</td>
                        <td>${formatDate(insumo.ultimaActualizacion)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="card mt-6">
                    <div class="card-header">
                        <h3 class="card-title">Resumen</h3>
                    </div>
                    <div class="card-body">
                        <p><strong>Total de insumos:</strong> ${db.insumos.length}</p>
                        <p><strong>Insumos bajo stock m√≠nimo:</strong> ${db.insumos.filter(i => i.stock < i.stockMinimo).length}</p>
                        <p><strong>Total unidades en inventario:</strong> ${db.insumos.reduce((sum, i) => sum + i.stock, 0)}</p>
                    </div>
                </div>
            `;

            return html;
        }

        function generarReporteMovimientos(db, fechaInicio, fechaFin) {
            // Filtrar movimientos por fecha
            const movimientos = db.entregas.filter(e => {
                return e.fecha >= fechaInicio && e.fecha <= fechaFin;
            });

            let html = `
                <h3>Reporte de Movimientos de Inventario</h3>
                <p>Per√≠odo: ${formatDate(fechaInicio)} - ${formatDate(fechaFin)}</p>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Insumo</th>
                                <th>Cantidad</th>
                                <th>Destino/Origen</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (movimientos.length === 0) {
                html += `
                    <tr>
                        <td colspan="6" class="text-center">No hay movimientos en el per√≠odo seleccionado</td>
                    </tr>
                `;
            } else {
                // Ordenar movimientos por fecha (m√°s reciente primero)
                const movimientosOrdenados = [...movimientos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                movimientosOrdenados.forEach(mov => {
                    mov.insumos.forEach(item => {
                        const insumo = db.insumos.find(i => i.id === item.insumoId);
                        let destinoOrigen = '';

                        if (mov.tipo === 'entrega') {
                            const aseador = db.personal.find(p => p.id === mov.aseadorId);
                            destinoOrigen = aseador ? aseador.nombre : 'Desconocido';
                        } else {
                            destinoOrigen = mov.origen || 'Desconocido';
                        }

                        html += `
                            <tr>
                                <td>${formatDate(mov.fecha)}</td>
                                <td>${mov.tipo === 'entrega' ? 'Salida' : 'Entrada'}</td>
                                <td>${insumo ? insumo.nombre : 'Desconocido'}</td>
                                <td>${item.cantidad} ${insumo ? insumo.unidad : 'unidades'}</td>
                                <td>${destinoOrigen}</td>
                                <td>${mov.motivo ? capitalize(mov.motivo) : '-'}</td>
                            </tr>
                        `;
                    });
                });
            }

            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="card mt-6">
                    <div class="card-header">
                        <h3 class="card-title">Resumen</h3>
                    </div>
                    <div class="card-body">
                        <p><strong>Total de movimientos:</strong> ${movimientos.length}</p>
                        <p><strong>Entradas:</strong> ${movimientos.filter(m => m.tipo === 'recepcion').length}</p>
                        <p><strong>Salidas:</strong> ${movimientos.filter(m => m.tipo === 'entrega').length}</p>
                    </div>
                </div>
            `;

            return html;
        }

        function generarReporteEntregas(db, fechaInicio, fechaFin) {
            // Filtrar entregas por fecha
            const entregas = db.entregas.filter(e => {
                return e.tipo === 'entrega' && e.fecha >= fechaInicio && e.fecha <= fechaFin;
            });

            let html = `
                <h3>Reporte de Entregas por Aseador</h3>
                <p>Per√≠odo: ${formatDate(fechaInicio)} - ${formatDate(fechaFin)}</p>
            `;

            if (entregas.length === 0) {
                html += `
                    <div class="alert alert-info">
                        <div class="alert-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">Sin datos</div>
                            <p>No hay entregas registradas en el per√≠odo seleccionado</p>
                        </div>
                    </div>
                `;
            } else {
                // Agrupar por aseador
                const entregasPorAseador = {};

                entregas.forEach(entrega => {
                    const aseador = db.personal.find(p => p.id === entrega.aseadorId);
                    const aseadorNombre = aseador ? aseador.nombre : 'Desconocido';

                    if (!entregasPorAseador[aseadorNombre]) {
                        entregasPorAseador[aseadorNombre] = [];
                    }

                    entregasPorAseador[aseadorNombre].push(entrega);
                });

                // Generar reporte por cada aseador
                for (const aseadorNombre in entregasPorAseador) {
                    const entregasAseador = entregasPorAseador[aseadorNombre];

                    html += `
                        <div class="card mb-6">
                            <div class="card-header">
                                <h3 class="card-title">${aseadorNombre}</h3>
                                <p>Total de entregas: ${entregasAseador.length}</p>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Insumo</th>
                                                <th>Cantidad</th>
                                                <th>Motivo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;

                    // Ordenar entregas por fecha (m√°s reciente primero)
                    const entregasOrdenadas = [...entregasAseador].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                    entregasOrdenadas.forEach(entrega => {
                        entrega.insumos.forEach(item => {
                            const insumo = db.insumos.find(i => i.id === item.insumoId);

                            html += `
                                <tr>
                                    <td>${formatDate(entrega.fecha)}</td>
                                    <td>${insumo ? insumo.nombre : 'Desconocido'}</td>
                                    <td>${item.cantidad} ${insumo ? insumo.unidad : 'unidades'}</td>
                                    <td>${entrega.motivo ? capitalize(entrega.motivo) : '-'}</td>
                                </tr>
                            `;
                        });
                    });

                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            return html;
        }

        function generarReporteConsumo(db, fechaInicio, fechaFin) {
            // Filtrar entregas por fecha
            const entregas = db.entregas.filter(e => {
                return e.tipo === 'entrega' && e.fecha >= fechaInicio && e.fecha <= fechaFin;
            });

            let html = `
                <h3>Reporte de Consumo de Insumos</h3>
                <p>Per√≠odo: ${formatDate(fechaInicio)} - ${formatDate(fechaFin)}</p>
            `;

            if (entregas.length === 0) {
                html += `
                    <div class="alert alert-info">
                        <div class="alert-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">Sin datos</div>
                            <p>No hay entregas registradas en el per√≠odo seleccionado</p>
                        </div>
                    </div>
                `;
            } else {
                // Calcular consumo por insumo
                const consumoPorInsumo = {};

                entregas.forEach(entrega => {
                    entrega.insumos.forEach(item => {
                        const insumoId = item.insumoId;

                        if (!consumoPorInsumo[insumoId]) {
                            const insumo = db.insumos.find(i => i.id === insumoId);
                            consumoPorInsumo[insumoId] = {
                                nombre: insumo ? insumo.nombre : 'Desconocido',
                                unidad: insumo ? insumo.unidad : 'unidades',
                                cantidad: 0,
                                entregas: 0
                            };
                        }

                        consumoPorInsumo[insumoId].cantidad += item.cantidad;
                        consumoPorInsumo[insumoId].entregas++;
                    });
                });

                html += `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th>Cantidad Total</th>
                                    <th>N¬∫ de Entregas</th>
                                    <th>Promedio por Entrega</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Ordenar por consumo (mayor a menor)
                const consumoOrdenado = Object.values(consumoPorInsumo).sort((a, b) => b.cantidad - a.cantidad);

                consumoOrdenado.forEach(consumo => {
                    const promedio = (consumo.cantidad / consumo.entregas).toFixed(2);

                    html += `
                        <tr>
                            <td>${consumo.nombre}</td>
                            <td>${consumo.cantidad} ${consumo.unidad}</td>
                            <td>${consumo.entregas}</td>
                            <td>${promedio} ${consumo.unidad}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="card mt-6">
                        <div class="card-header">
                            <h3 class="card-title">Resumen</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Total de insumos entregados:</strong> ${Object.values(consumoPorInsumo).reduce((sum, i) => sum + i.cantidad, 0)} unidades</p>
                            <p><strong>Total de entregas realizadas:</strong> ${entregas.length}</p>
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function generarReportePrestamos(db, fechaInicio, fechaFin) {
            // Filtrar pr√©stamos por fecha
            const prestamos = db.prestamos.filter(p => {
                return p.fecha >= fechaInicio && p.fecha <= fechaFin;
            });

            let html = `
                <h3>Reporte de Pr√©stamos y Devoluciones</h3>
                <p>Per√≠odo: ${formatDate(fechaInicio)} - ${formatDate(fechaFin)}</p>
            `;

            if (prestamos.length === 0) {
                html += `
                    <div class="alert alert-info">
                        <div class="alert-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">Sin datos</div>
                            <p>No hay pr√©stamos registrados en el per√≠odo seleccionado</p>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Terminal</th>
                                    <th>Tipo</th>
                                    <th>Insumo</th>
                                    <th>Cantidad</th>
                                    <th>Estado</th>
                                    <th>Fecha Devoluci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Ordenar pr√©stamos por fecha (m√°s reciente primero)
                const prestamosOrdenados = [...prestamos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                prestamosOrdenados.forEach(prestamo => {
                    prestamo.insumos.forEach(item => {
                        const insumo = db.insumos.find(i => i.id === item.insumoId);

                        html += `
                            <tr>
                                <td>${formatDate(prestamo.fecha)}</td>
                                <td>${prestamo.terminal}</td>
                                <td>${prestamo.tipo === 'salida' ? 'Entregado' : 'Recibido'}</td>
                                <td>${insumo ? insumo.nombre : 'Desconocido'}</td>
                                <td>${item.cantidad} ${insumo ? insumo.unidad : 'unidades'}</td>
                                <td>${capitalize(prestamo.estado)}</td>
                                <td>${prestamo.fechaDevolucionReal ? formatDate(prestamo.fechaDevolucionReal) : (prestamo.fechaDevolucion ? formatDate(prestamo.fechaDevolucion) : '-')}</td>
                            </tr>
                        `;
                    });
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="card mt-6">
                        <div class="card-header">
                            <h3 class="card-title">Resumen</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Total de pr√©stamos:</strong> ${prestamos.length}</p>
                            <p><strong>Pr√©stamos entregados:</strong> ${prestamos.filter(p => p.tipo === 'salida').length}</p>
                            <p><strong>Pr√©stamos recibidos:</strong> ${prestamos.filter(p => p.tipo === 'entrada').length}</p>
                            <p><strong>Pendientes de devoluci√≥n:</strong> ${prestamos.filter(p => p.estado === 'pendiente').length}</p>
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // =========================================
        // VERIFICACI√ìN DIARIA DE ALERTAS
        // =========================================

        function verificarAlertasDiarias() {
            const db = getDB();

            // Alertas de stock bajo
            const insumosBajoStock = db.insumos.filter(i => i.stock < i.stockMinimo);

            if (insumosBajoStock.length > 0 && db.configuracion.emailNotificaciones &&
                db.configuracion.notificaciones.bajoStock && isConnectedToSheets) {

                callGoogleScript('sendEmailNotification', {
                    type: 'bajoStock',
                    emailData: {
                        insumos: insumosBajoStock.map(i => `${i.nombre} (${i.stock}/${i.stockMinimo})`).join(', ')
                    }
                }).catch(console.error);
            }

            // Alertas de entregas programadas
            const hoy = new Date().toISOString().split('T')[0];
            const programadasHoy = db.programaciones.filter(p => p.proximaEntrega === hoy && p.estado === 'activa');

            if (programadasHoy.length > 0 && db.configuracion.emailNotificaciones &&
                db.configuracion.notificaciones.entregas && isConnectedToSheets) {

                callGoogleScript('sendEmailNotification', {
                    type: 'programacionHoy',
                    emailData: {
                        entregas: programadasHoy.map(p => {
                            const aseador = db.personal.find(a => a.id === p.aseadorId);
                            const insumo = db.insumos.find(i => i.id === p.insumoId);
                            return `${p.cantidad} ${insumo?.nombre || 'Insumo desconocido'} para ${aseador?.nombre || 'Desconocido'}`;
                        }).join(', ')
                    }
                }).catch(console.error);
            }

            // Alertas de pr√©stamos pendientes de devoluci√≥n
            const prestamosPendientes = db.prestamos.filter(p => {
                if (p.estado !== 'pendiente' || !p.fechaDevolucion) return false;

                const fechaDevolucion = new Date(p.fechaDevolucion);
                const hoyDate = new Date(hoy);

                // Pr√©stamos con fecha de devoluci√≥n hoy o vencidos
                return fechaDevolucion <= hoyDate;
            });

            if (prestamosPendientes.length > 0 && db.configuracion.emailNotificaciones &&
                db.configuracion.notificaciones.prestamos && isConnectedToSheets) {

                callGoogleScript('sendEmailNotification', {
                    type: 'prestamosVencidos',
                    emailData: {
                        prestamos: prestamosPendientes.map(p => {
                            const diasVencido = Math.floor((new Date(hoy) - new Date(p.fechaDevolucion)) / (1000 * 60 * 60 * 24));
                            return `${p.terminal} (${diasVencido > 0 ? `Vencido por ${diasVencido} d√≠as` : 'Vence hoy'})`;
                        }).join(', ')
                    }
                }).catch(console.error);
            }
        }
    </script>
</body>

</html>